<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>استعراض الملفات</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#5D5CDE',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            secondary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
              950: '#082f49',
            },
            accent: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#fbcfe8',
              300: '#f9a8d4',
              400: '#f472b6',
              500: '#ec4899',
              600: '#db2777',
              700: '#be185d',
              800: '#9d174d',
              900: '#831843',
              950: '#500724',
            },
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            dark: {
              background: '#121212',
              surface: '#1e1e1e',
              border: '#2e2e2e'
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-background dark:text-gray-100 min-h-screen transition-colors duration-200">
  
  <!-- التحقق من وضع الظلام -->
  <script>
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
  </script>

  <!-- الهيدر -->
  <header class="bg-gradient-to-r from-primary-600 to-secondary-600 text-white shadow-lg dark:from-primary-800 dark:to-secondary-800">
    <div class="container mx-auto py-6 px-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl md:text-3xl font-bold flex items-center">
          <i class="fas fa-folder-open text-yellow-300 mr-3 animate-pulse-slow"></i>
          <span class="relative">
            استعراض الملفات
            <span class="absolute -bottom-1 left-0 w-full h-1 bg-yellow-300 rounded-full opacity-70"></span>
          </span>
        </h1>
        <div class="flex items-center space-x-4 space-x-reverse">
          <button id="darkModeToggle" class="p-2 rounded-full hover:bg-white/20 transition-colors">
            <i class="fas fa-moon text-xl dark:hidden"></i>
            <i class="fas fa-sun text-xl hidden dark:block"></i>
          </button>
          <a href="index.html" class="flex items-center bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg transition-colors">
            <i class="fas fa-home ml-2"></i>
            <span class="hidden md:inline">الرئيسية</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- مسار التنقل -->
  <div class="container mx-auto mt-6 px-4">
    <div id="breadcrumb" class="bg-white dark:bg-dark-surface rounded-lg shadow p-3 flex flex-wrap items-center text-sm md:text-base overflow-x-auto">
      <!-- سيتم إضافة مسار التنقل بواسطة JavaScript -->
    </div>
  </div>

  <!-- قسم البحث -->
  <div class="container mx-auto mt-4 px-4">
    <div class="relative">
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <i class="fas fa-search text-gray-500 dark:text-gray-400"></i>
      </div>
      <input 
        type="text" 
        id="searchInput" 
        class="block w-full p-3 pr-10 text-base text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-primary-600 focus:border-primary-600 dark:bg-dark-surface dark:border-dark-border dark:placeholder-gray-400 dark:text-white" 
        placeholder="البحث في الملفات الحالية..."
      >
    </div>
  </div>

  <!-- قسم المحتوى الرئيسي -->
  <main class="container mx-auto mt-6 px-4 pb-12">
    <!-- حالة التحميل -->
    <div id="loadingState" class="flex flex-col items-center justify-center py-16">
      <div class="w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
      <p class="mt-4 text-gray-600 dark:text-gray-300">جاري تحميل الملفات...</p>
    </div>

    <!-- قائمة الملفات -->
    <div id="fileContent" class="hidden">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="fileGrid">
        <!-- سيتم إضافة الملفات هنا -->
      </div>
    </div>

    <!-- رسالة عند عدم وجود ملفات -->
    <div id="emptyMessage" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <div class="text-6xl mb-4 text-gray-400 dark:text-gray-600">
        <i class="fas fa-folder-open"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">المجلد فارغ</h2>
      <p class="text-gray-500 dark:text-gray-400 max-w-md">لا توجد ملفات في هذا المجلد أو حدث خطأ أثناء تحميل المحتوى.</p>
    </div>

    <!-- رسالة الخطأ -->
    <div id="errorMessage" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <div class="text-6xl mb-4 text-error">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h2 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">حدث خطأ</h2>
      <p class="text-gray-500 dark:text-gray-400 max-w-md">تعذر تحميل محتوى هذا المجلد. يرجى المحاولة مرة أخرى لاحقًا.</p>
      <button id="retryButton" class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
        <i class="fas fa-redo ml-1"></i>إعادة المحاولة
      </button>
    </div>
    
    <!-- مودال عرض الملف -->
    <div id="fileViewerModal" class="fixed inset-0 bg-black/70 dark:bg-black/80 z-50 flex items-center justify-center hidden">
      <div class="relative bg-white dark:bg-dark-surface rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
        <div class="flex justify-between items-center p-4 border-b dark:border-dark-border">
          <h3 id="fileViewerTitle" class="font-bold text-lg"></h3>
          <button id="closeFileViewer" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <div id="fileViewerContent" class="p-4 overflow-auto max-h-[calc(90vh-80px)]">
          <!-- سيتم إضافة محتوى الملف هنا -->
        </div>
        <div class="p-4 border-t dark:border-dark-border flex justify-end">
          <a id="downloadFileLink" href="#" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors" download>
            <i class="fas fa-download ml-1"></i>تحميل الملف
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- الفوتر -->
  <footer class="bg-white dark:bg-dark-surface border-t dark:border-dark-border py-4 mt-auto">
    <div class="container mx-auto px-4 text-center">
      <p class="text-gray-600 dark:text-gray-400">&copy; 2025 منصة التعليم الجزائري - جميع الحقوق محفوظة</p>
    </div>
  </footer>

  <!-- دليل الأيقونات -->
  <div id="iconGuide" class="fixed bottom-4 right-4 z-50">
    <button class="bg-primary-600 hover:bg-primary-700 text-white p-3 rounded-full shadow-lg transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary-400 dark:focus:ring-primary-600">
      <i class="fas fa-question"></i>
    </button>
    <div class="absolute bottom-full right-0 mb-2 w-64 p-4 bg-white dark:bg-dark-surface rounded-lg shadow-xl hidden transition-opacity" id="iconGuideContent">
      <h3 class="font-bold mb-2 border-b pb-1 dark:border-dark-border">دليل الأيقونات</h3>
      <ul class="text-sm space-y-2">
        <li class="flex items-center"><i class="fas fa-folder text-yellow-500 ml-2"></i> مجلد</li>
        <li class="flex items-center"><i class="fas fa-file-pdf text-red-500 ml-2"></i> ملف PDF</li>
        <li class="flex items-center"><i class="fas fa-file-word text-blue-500 ml-2"></i> ملف Word</li>
        <li class="flex items-center"><i class="fas fa-file-excel text-green-500 ml-2"></i> ملف Excel</li>
        <li class="flex items-center"><i class="fas fa-file-powerpoint text-orange-500 ml-2"></i> ملف PowerPoint</li>
        <li class="flex items-center"><i class="fas fa-file-image text-purple-500 ml-2"></i> صورة</li>
        <li class="flex items-center"><i class="fas fa-file-alt text-gray-500 ml-2"></i> ملف نصي</li>
        <li class="flex items-center"><i class="fas fa-file text-gray-400 ml-2"></i> ملف آخر</li>
      </ul>
    </div>
  </div>

  <script>
    // متغيرات التهيئة
    const username = "linnkou";
    const repo = "majani";
    const branch = "main";

    // الحصول على المسار
    const params = new URLSearchParams(window.location.search);
    const path = params.get("path") || "";
    
    // تحديد عناصر DOM
    const breadcrumb = document.getElementById("breadcrumb");
    const loadingState = document.getElementById("loadingState");
    const fileContent = document.getElementById("fileContent");
    const fileGrid = document.getElementById("fileGrid");
    const emptyMessage = document.getElementById("emptyMessage");
    const errorMessage = document.getElementById("errorMessage");
    const searchInput = document.getElementById("searchInput");
    const iconGuideButton = document.querySelector("#iconGuide button");
    const iconGuideContent = document.getElementById("iconGuideContent");
    const retryButton = document.getElementById("retryButton");
    const darkModeToggle = document.getElementById("darkModeToggle");
    
    // عناصر DOM للمودال
    const fileViewerModal = document.getElementById("fileViewerModal");
    const fileViewerTitle = document.getElementById("fileViewerTitle");
    const fileViewerContent = document.getElementById("fileViewerContent");
    const closeFileViewer = document.getElementById("closeFileViewer");
    const downloadFileLink = document.getElementById("downloadFileLink");

    // تخزين بيانات الملفات والمجلدات
    let filesData = [];

    // تحميل الملفات
    function loadFiles() {
      // إظهار حالة التحميل
      loadingState.classList.remove("hidden");
      fileContent.classList.add("hidden");
      emptyMessage.classList.add("hidden");
      errorMessage.classList.add("hidden");

      // إعداد مسار API
      const fullPath = "educationdzwordland/" + path;
      const encodedPath = fullPath.split("/").map(encodeURIComponent).join("/");
      const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${encodedPath}?ref=${branch}`;

      // إعداد مسار التنقل (breadcrumb)
      setupBreadcrumb();

      // جلب البيانات
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`استجابة غير ناجحة: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // إخفاء حالة التحميل
          loadingState.classList.add("hidden");
          
          if (!Array.isArray(data)) {
            // إذا كانت الاستجابة ليست مصفوفة، فهذا يعني أنها ملف واحد
            handleSingleFile(data);
            return;
          }

          // تصفية الملفات المخفية وتخزينها
          filesData = data.filter(item => !item.name.startsWith('.'));

          if (filesData.length === 0) {
            emptyMessage.classList.remove("hidden");
            return;
          }

          // عرض المحتوى
          fileContent.classList.remove("hidden");
          
          // فرز العناصر: المجلدات أولاً ثم الملفات، وكلاهما مرتب أبجديًا
          filesData.sort((a, b) => {
            if (a.type !== b.type) {
              return a.type === "dir" ? -1 : 1;
            }
            return a.name.localeCompare(b.name);
          });

          // مسح المحتوى الحالي
          fileGrid.innerHTML = '';
          
          // إضافة العناصر
          filesData.forEach(item => {
            const card = createFileCard(item);
            fileGrid.appendChild(card);
          });

          // إضافة معالج البحث
          setupSearch();
        })
        .catch(error => {
          loadingState.classList.add("hidden");
          errorMessage.classList.remove("hidden");
          console.error("حدث خطأ:", error);
        });
    }

    // إنشاء بطاقة ملف
    function createFileCard(item) {
      const card = document.createElement("div");
      card.className = "bg-white dark:bg-dark-surface rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow border border-gray-100 dark:border-dark-border group cursor-pointer";
      card.setAttribute("data-name", item.name.toLowerCase());
      card.setAttribute("data-type", item.type);
      card.setAttribute("data-item-sha", item.sha);
      card.setAttribute("data-item-path", item.path);
      card.setAttribute("data-download-url", item.download_url || "");
      
      // تحديد نوع الأيقونة والألوان
      const { icon, bgColor, textColor } = getFileIconAndColors(item);
      
      // إنشاء محتوى البطاقة
      const cardContent = `
        <div class="${bgColor} ${textColor} p-4 flex justify-center items-center h-32 group-hover:scale-105 transition-transform">
          <i class="${icon} text-5xl transition-transform group-hover:scale-110"></i>
        </div>
        <div class="p-4">
          <h3 class="font-bold text-gray-800 dark:text-gray-100 mb-1 line-clamp-1" title="${item.name}">${item.name}</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            ${item.type === "dir" ? "مجلد" : getFileExtension(item.name)}
          </p>
        </div>
      `;
      
      card.innerHTML = cardContent;
      
      // إضافة معالج النقر للعنصر
      card.addEventListener('click', () => handleItemClick(item));
      
      return card;
    }

    // معالجة النقر على العنصر
    function handleItemClick(item) {
      if (item.type === "dir") {
        // إذا كان مجلد، انتقل إلى المسار الجديد
        const newPath = path ? path + "/" + item.name : item.name;
        window.location.href = `file-browser.html?path=${encodeURIComponent(newPath)}`;
      } else {
        // إذا كان ملف، عرض المودال
        showFileViewer(item);
      }
    }

    // عرض مودال عارض الملفات
    function showFileViewer(item) {
      // تعيين عنوان الملف
      fileViewerTitle.textContent = item.name;
      
      // تحديد رابط التحميل
      downloadFileLink.href = item.download_url;
      downloadFileLink.setAttribute('download', item.name);
      
      // تحديد محتوى العارض حسب نوع الملف
      setFileViewerContent(item);
      
      // إظهار المودال
      fileViewerModal.classList.remove('hidden');
      
      // منع التمرير في الصفحة الرئيسية
      document.body.style.overflow = 'hidden';
    }

    // تعيين محتوى عارض الملفات بناءً على نوع الملف
    function setFileViewerContent(item) {
      // مسح المحتوى السابق
      fileViewerContent.innerHTML = '';
      
      // عرض حالة التحميل
      fileViewerContent.innerHTML = `
        <div class="flex flex-col items-center justify-center py-8">
          <div class="w-12 h-12 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="mt-4 text-gray-600 dark:text-gray-300">جاري تحميل محتوى الملف...</p>
        </div>
      `;
      
      const extension = item.name.split('.').pop().toLowerCase();
      
      // عرض الملف حسب نوعه
      if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
        // صور
        const img = document.createElement('img');
        img.src = item.download_url;
        img.className = 'max-w-full h-auto mx-auto';
        img.alt = item.name;
        
        img.onload = () => {
          fileViewerContent.innerHTML = '';
          fileViewerContent.appendChild(img);
        };
        
        img.onerror = () => {
          fileViewerContent.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4 text-error">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <p>تعذر تحميل الصورة. يرجى تجربة تحميل الملف مباشرة.</p>
            </div>
          `;
        };
      } else if (['mp4', 'webm', 'ogg'].includes(extension)) {
        // فيديو
        const video = document.createElement('video');
        video.src = item.download_url;
        video.className = 'max-w-full h-auto mx-auto';
        video.controls = true;
        
        video.onloadeddata = () => {
          fileViewerContent.innerHTML = '';
          fileViewerContent.appendChild(video);
        };
        
        video.onerror = () => {
          fileViewerContent.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4 text-error">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <p>تعذر تحميل الفيديو. يرجى تجربة تحميل الملف مباشرة.</p>
            </div>
          `;
        };
      } else if (['mp3', 'wav'].includes(extension)) {
        // صوت
        const audio = document.createElement('audio');
        audio.src = item.download_url;
        audio.className = 'w-full';
        audio.controls = true;
        
        audio.onloadeddata = () => {
          fileViewerContent.innerHTML = '';
          fileViewerContent.appendChild(audio);
        };
        
        audio.onerror = () => {
          fileViewerContent.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4 text-error">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <p>تعذر تحميل الملف الصوتي. يرجى تجربة تحميل الملف مباشرة.</p>
            </div>
          `;
        };
      } else if (['pdf'].includes(extension)) {
        // ملفات PDF
        fileViewerContent.innerHTML = `
          <div class="flex flex-col h-[500px]">
            <iframe src="${item.download_url}" class="w-full h-full rounded border dark:border-dark-border"></iframe>
          </div>
        `;
      } else if (['txt', 'md', 'json', 'xml', 'csv', 'html', 'css', 'js'].includes(extension)) {
        // ملفات نصية
        fetch(item.download_url)
          .then(response => response.text())
          .then(text => {
            fileViewerContent.innerHTML = `
              <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded overflow-x-auto whitespace-pre-wrap">${escapeHtml(text)}</pre>
            `;
          })
          .catch(() => {
            fileViewerContent.innerHTML = `
              <div class="text-center py-8">
                <div class="text-4xl mb-4 text-error">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <p>تعذر تحميل محتوى الملف. يرجى تجربة تحميل الملف مباشرة.</p>
              </div>
            `;
          });
      } else {
        // أنواع أخرى من الملفات
        fileViewerContent.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4 ${getFileIconAndColors(item).textColor}">
              <i class="${getFileIconAndColors(item).icon}"></i>
            </div>
            <p class="text-xl font-bold mb-2">${item.name}</p>
            <p class="mb-4">هذا النوع من الملفات لا يمكن عرضه مباشرة. يرجى تحميل الملف لعرضه.</p>
            <div class="mt-4">
              <button id="viewerDownloadBtn" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-download ml-1"></i>تحميل الملف
              </button>
            </div>
          </div>
        `;
        
        // إضافة معالج النقر لزر التحميل داخل المودال
        setTimeout(() => {
          const viewerDownloadBtn = document.getElementById("viewerDownloadBtn");
          if (viewerDownloadBtn) {
            viewerDownloadBtn.addEventListener('click', () => {
              downloadFileLink.click();
            });
          }
        }, 100);
      }
    }

    // تهروب النص HTML
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // الحصول على أيقونة الملف وألوانه
    function getFileIconAndColors(item) {
      if (item.type === "dir") {
        return {
          icon: "fas fa-folder",
          bgColor: "bg-yellow-50 dark:bg-yellow-900/30",
          textColor: "text-yellow-500 dark:text-yellow-400"
        };
      }
      
      const extension = item.name.split('.').pop().toLowerCase();
      
      const fileTypes = {
        pdf: {
          icon: "fas fa-file-pdf",
          bgColor: "bg-red-50 dark:bg-red-900/30",
          textColor: "text-red-500 dark:text-red-400"
        },
        doc: {
          icon: "fas fa-file-word",
          bgColor: "bg-blue-50 dark:bg-blue-900/30",
          textColor: "text-blue-500 dark:text-blue-400"
        },
        docx: {
          icon: "fas fa-file-word",
          bgColor: "bg-blue-50 dark:bg-blue-900/30",
          textColor: "text-blue-500 dark:text-blue-400"
        },
        xls: {
          icon: "fas fa-file-excel",
          bgColor: "bg-green-50 dark:bg-green-900/30",
          textColor: "text-green-500 dark:text-green-400"
        },
        xlsx: {
          icon: "fas fa-file-excel",
          bgColor: "bg-green-50 dark:bg-green-900/30",
          textColor: "text-green-500 dark:text-green-400"
        },
        ppt: {
          icon: "fas fa-file-powerpoint",
          bgColor: "bg-orange-50 dark:bg-orange-900/30",
          textColor: "text-orange-500 dark:text-orange-400"
        },
        pptx: {
          icon: "fas fa-file-powerpoint",
          bgColor: "bg-orange-50 dark:bg-orange-900/30",
          textColor: "text-orange-500 dark:text-orange-400"
        },
        jpg: {
          icon: "fas fa-file-image",
          bgColor: "bg-purple-50 dark:bg-purple-900/30",
          textColor: "text-purple-500 dark:text-purple-400"
        },
        jpeg: {
          icon: "fas fa-file-image",
          bgColor: "bg-purple-50 dark:bg-purple-900/30",
          textColor: "text-purple-500 dark:text-purple-400"
        },
        png: {
          icon: "fas fa-file-image",
          bgColor: "bg-purple-50 dark:bg-purple-900/30",
          textColor: "text-purple-500 dark:text-purple-400"
        },
        gif: {
          icon: "fas fa-file-image",
          bgColor: "bg-purple-50 dark:bg-purple-900/30",
          textColor: "text-purple-500 dark:text-purple-400"
        },
        txt: {
          icon: "fas fa-file-alt",
          bgColor: "bg-gray-50 dark:bg-gray-700/50",
          textColor: "text-gray-500 dark:text-gray-300"
        },
        zip: {
          icon: "fas fa-file-archive",
          bgColor: "bg-yellow-50 dark:bg-yellow-900/30",
          textColor: "text-yellow-600 dark:text-yellow-400"
        },
        rar: {
          icon: "fas fa-file-archive",
          bgColor: "bg-yellow-50 dark:bg-yellow-900/30",
          textColor: "text-yellow-600 dark:text-yellow-400"
        },
        mp3: {
          icon: "fas fa-file-audio",
          bgColor: "bg-blue-50 dark:bg-blue-900/30",
          textColor: "text-blue-500 dark:text-blue-400"
        },
        wav: {
          icon: "fas fa-file-audio",
          bgColor: "bg-blue-50 dark:bg-blue-900/30",
          textColor: "text-blue-500 dark:text-blue-400"
        },
        mp4: {
          icon: "fas fa-file-video",
          bgColor: "bg-red-50 dark:bg-red-900/30",
          textColor: "text-red-500 dark:text-red-400"
        },
        webm: {
          icon: "fas fa-file-video",
          bgColor: "bg-red-50 dark:bg-red-900/30",
          textColor: "text-red-500 dark:text-red-400"
        }
      };
      
      return fileTypes[extension] || {
        icon: "fas fa-file",
        bgColor: "bg-gray-50 dark:bg-gray-800",
        textColor: "text-gray-400 dark:text-gray-500"
      };
    }

    // إعداد مسار التنقل (breadcrumb)
    function setupBreadcrumb() {
      // مسح المحتوى السابق
      breadcrumb.innerHTML = '';
      
      // إذا كان المسار فارغًا، لا نحتاج لإضافة أي عناصر
      if (!path) return;
      
      // توليد مكونات المسار
      const pathParts = path.split('/');
      
      // إضافة فقط الجزء الأخير من المسار
      const lastPart = pathParts[pathParts.length - 1];
      
      // إنشاء عنصر النص
      const folderName = document.createElement('span');
      folderName.className = 'text-gray-800 dark:text-gray-200 font-bold flex items-center';
      folderName.innerHTML = `<i class="fas fa-folder-open text-yellow-500 dark:text-yellow-400 ml-2"></i>${lastPart}`;
      
      breadcrumb.appendChild(folderName);
      
      // تخزين المسار الكامل في خاصية مخفية للاستخدام لاحقًا إذا لزم الأمر
      breadcrumb.setAttribute('data-full-path', path);
    }

    // إعداد وظيفة البحث
    function setupSearch() {
      searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        const cards = fileGrid.querySelectorAll('div[data-name]');
        
        // إذا كان البحث فارغًا، أظهر كل العناصر
        if (query === '') {
          cards.forEach(card => card.classList.remove('hidden'));
          return;
        }
        
        // تطبيق تصفية على البطاقات
        cards.forEach(card => {
          const name = card.getAttribute('data-name');
          if (name.includes(query)) {
            card.classList.remove('hidden');
          } else {
            card.classList.add('hidden');
          }
        });
        
        // إظهار رسالة إذا لم يتم العثور على نتائج
        const visibleCards = fileGrid.querySelectorAll('div[data-name]:not(.hidden)');
        if (visibleCards.length === 0) {
          // إنشاء رسالة "لا توجد نتائج" إذا لم تكن موجودة
          let noResults = fileGrid.querySelector('.no-results');
          if (!noResults) {
            noResults = document.createElement('div');
            noResults.className = 'no-results col-span-full py-8 text-center text-gray-500 dark:text-gray-400';
            noResults.innerHTML = `
              <i class="fas fa-search mb-2 text-3xl"></i>
              <p>لم يتم العثور على نتائج مطابقة لـ "${query}"</p>
            `;
            fileGrid.appendChild(noResults);
          } else {
            noResults.querySelector('p').textContent = `لم يتم العثور على نتائج مطابقة لـ "${query}"`;
            noResults.classList.remove('hidden');
          }
        } else {
          // إخفاء رسالة "لا توجد نتائج" إذا كانت موجودة
          const noResults = fileGrid.querySelector('.no-results');
          if (noResults) {
            noResults.classList.add('hidden');
          }
        }
      });
    }

    // معالجة ملف وحيد (عرض المودال)
    function handleSingleFile(file) {
      showFileViewer(file);
    }

    // الحصول على امتداد الملف
    function getFileExtension(filename) {
      const parts = filename.split('.');
      const extension = parts.length > 1 ? parts.pop().toUpperCase() : '';
      return extension ? `ملف ${extension}` : 'ملف';
    }

    // إعداد معالجات الأحداث
    function setupEventListeners() {
      // زر إعادة المحاولة
      retryButton.addEventListener('click', loadFiles);
      
      // زر تبديل الوضع المظلم
      darkModeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
      });
      
      // دليل الأيقونات
      iconGuideButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // منع انتشار الحدث
        iconGuideContent.classList.toggle('hidden');
      });
      
      // إخفاء دليل الأيقونات عند النقر خارجه
      document.addEventListener('click', (e) => {
        if (!iconGuide.contains(e.target)) {
          iconGuideContent.classList.add('hidden');
        }
      });
      
      // إغلاق مودال عارض الملفات
      closeFileViewer.addEventListener('click', () => {
        fileViewerModal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // إعادة تمكين التمرير
      });
      
      // إغلاق المودال عند النقر خارج المحتوى
      fileViewerModal.addEventListener('click', (e) => {
        if (e.target === fileViewerModal) {
          fileViewerModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
      
      // إغلاق المودال بزر Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !fileViewerModal.classList.contains('hidden')) {
          fileViewerModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      loadFiles();
    });
  </script>
</body>
</html>