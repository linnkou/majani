<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<style>
  #breadcrumb {
    display: none !important;
  }
</style>

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>استعراض الملفات</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#5D5CDE',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            secondary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
              950: '#082f49',
            },
            accent: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#fbcfe8',
              300: '#f9a8d4',
              400: '#f472b6',
              500: '#ec4899',
              600: '#db2777',
              700: '#be185d',
              800: '#9d174d',
              900: '#831843',
              950: '#500724',
            },
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            dark: {
              background: '#121212',
              surface: '#1e1e1e',
              border: '#2e2e2e'
            }
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'bounce-slow': 'bounce 2s infinite',
            'fire': 'fire 1.5s ease-in-out infinite alternate',
            'glow': 'glow 1.5s ease-in-out infinite alternate',
          },
          keyframes: {
            fire: {
              '0%': { boxShadow: '0 0 5px #ff6b6b, 0 0 10px #ff6b6b, 0 0 15px #ff9e6b, 0 0 20px #ffbc6b' },
              '100%': { boxShadow: '0 0 10px #ff6b6b, 0 0 20px #ff6b6b, 0 0 30px #ff9e6b, 0 0 40px #ffbc6b' },
            },
            glow: {
              '0%': { filter: 'brightness(1)' },
              '100%': { filter: 'brightness(1.2)' },
            }
          }
        }
      }
    }
  </script>
<style>
    .upload-btn {
      position: relative;
      overflow: hidden;
      background: linear-gradient(45deg, #ff3d00, #ff9e00);
      transition: all 0.3s ease;
    }
    
    .upload-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: all 0.6s ease;
    }
    
    .upload-btn:hover::before {
      left: 100%;
    }
    
    .upload-btn:hover {
      transform: translateY(-3px);
    }
    
    .fire-effect {
      animation: fire 1.5s ease-in-out infinite alternate;
    }
    
    .glow-text {
      text-shadow: 0 0 5px rgba(255, 157, 0, 0.7), 0 0 10px rgba(255, 157, 0, 0.5);
      animation: glow 1.5s ease-in-out infinite alternate;
    }
    
    .flames {
      position: absolute;
      bottom: -15px;
      left: 0;
      right: 0;
      height: 15px;
      background-image: 
        radial-gradient(circle at 20% 50%, #ff9d00 0%, transparent 50%),
        radial-gradient(circle at 40% 50%, #ff7300 0%, transparent 50%),
        radial-gradient(circle at 60% 50%, #ff5600 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, #ff3d00 0%, transparent 50%);
      filter: blur(5px);
      opacity: 0.8;
      transform-origin: center bottom;
      animation: flicker 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes flicker {
      0% { transform: scaleX(0.9) scaleY(0.9); opacity: 0.7; }
      100% { transform: scaleX(1.1) scaleY(1.1); opacity: 0.9; }
    }
    
    /* تحسين ظهور المجلدات والملفات */
    .file-card {
      transition: all 0.3s ease;
    }
    
    .file-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .dark .file-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    }
    
    /* تأثير التحميل المتموج */
    .ripple-loader {
      position: relative;
    }
    
    .ripple-loader::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background-color: rgba(99, 102, 241, 0.3);
      transform: translate(-50%, -50%);
      animation: ripple 1.5s ease-out infinite;
    }
    
    @keyframes ripple {
      0% { width: 0; height: 0; opacity: 1; }
      100% { width: 200px; height: 200px; opacity: 0; }
    }
    
    /* إشعارات المستخدم */
    .custom-notification {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-background dark:text-gray-100 min-h-screen transition-colors duration-200">
<!-- التحقق من وضع الظلام -->
<script>
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
  </script>
<!-- الهيدر -->
<header class="bg-gradient-to-r from-primary-600 to-secondary-600 text-white shadow-lg dark:from-primary-800 dark:to-secondary-800">
<div class="container mx-auto py-6 px-4">
<div class="flex justify-between items-center">
<h1 class="text-2xl md:text-3xl font-bold flex items-center">
<i class="fas fa-folder-open text-yellow-300 mr-3 animate-pulse-slow"></i>
<span class="relative">
            استعراض الملفات
            <span class="absolute -bottom-1 left-0 w-full h-1 bg-yellow-300 rounded-full opacity-70"></span>
</span>
</h1>
<div class="flex items-center space-x-4 space-x-reverse">
<button class="p-2 rounded-full hover:bg-white/20 transition-colors" id="darkModeToggle">
<i class="fas fa-moon text-xl dark:hidden"></i>
<i class="fas fa-sun text-xl hidden dark:block"></i>
</button>
<a class="flex items-center bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg transition-colors" href="index.html">
<i class="fas fa-home ml-2"></i>
<span class="hidden md:inline">الرئيسية</span>
</a>
</div>
</div>
</div>
</header>
<!-- مسار التنقل -->
<div class="container mx-auto mt-6 px-4">
<div class="bg-white dark:bg-dark-surface rounded-lg shadow p-3 flex flex-wrap items-center text-sm md:text-base gap-2 overflow-x-auto" id="breadcrumb">
<a href="file-browser.html" class="flex items-center text-primary-600 dark:text-primary-400 hover:underline">
<i class="fas fa-home ml-1"></i> الرئيسية
</a>
<!-- سيتم إضافة باقي مسار التنقل بواسطة JavaScript -->
</div>
</div>
<!-- قسم البحث -->
<div class="container mx-auto mt-4 px-4">
<div class="relative">
<div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
<i class="fas fa-search text-gray-500 dark:text-gray-400"></i>
</div>
<input class="block w-full p-3 pr-10 text-base text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-primary-600 focus:border-primary-600 dark:bg-dark-surface dark:border-dark-border dark:placeholder-gray-400 dark:text-white transition-all duration-300" id="searchInput" placeholder="البحث في الملفات الحالية..." type="text"/>
</div>
</div>

<!-- قسم رفع الملفات -->
<div class="container mx-auto mt-6 px-4">
  <!-- زر الرجوع إلى الرئيسية -->
  <div class="mb-4">
    <a href="index.html" class="inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
      <i class="fas fa-arrow-right ml-2"></i>
      <span>الرجوع إلى الرئيسية</span>
    </a>
  </div>

  <!-- قسم رفع الملفات الأصلي -->
  <div id="uploadContainer" class="bg-gradient-to-r from-amber-700 to-orange-600 dark:from-amber-900 dark:to-orange-800 rounded-lg shadow-lg p-4 mb-6 relative overflow-hidden">
    <div class="absolute inset-0 bg-black opacity-10 dark:opacity-30"></div>
    <div class="relative z-10">
      <div class="flex items-center mb-3">
        <i class="fas fa-fire text-yellow-300 text-2xl ml-2 glow-text"></i>
        <h3 class="font-bold text-xl text-white glow-text">رفع ملف جديد</h3>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 items-center">
        <div class="relative">
          <input type="file" id="uploadInput" class="opacity-0 absolute inset-0 w-full h-full cursor-pointer z-20" multiple/>
          <div class="bg-white/20 text-white px-4 py-2 rounded-lg flex items-center">
            <i class="fas fa-file-upload ml-2"></i>
            <span>اختر ملفات</span>
          </div>
          <p id="fileNameDisplay" class="text-sm text-white/80 mt-1 h-5 overflow-hidden whitespace-nowrap overflow-ellipsis max-w-xs"></p>
        </div>
        <button onclick="uploadFileToCurrent()" id="uploadButton" class="upload-btn text-white px-6 py-3 rounded-lg font-bold flex items-center justify-center relative fire-effect overflow-hidden">
          <i class="fas fa-cloud-upload-alt ml-2"></i>
          <span>رفع إلى هذا المجلد</span>
          <div class="flames"></div>
        </button>
      </div>
      <p class="text-xs text-white/70 mt-3">الملفات المدعومة: doc, docx, pdf, ppt, pptx, xls, xlsx, txt, jpg, png, zip</p>
    </div>
  </div>
</div>

<!-- قسم المحتوى الرئيسي -->
<main class="container mx-auto mt-2 px-4 pb-12">
<!-- حالة التحميل -->
<div class="flex flex-col items-center justify-center py-16 ripple-loader" id="loadingState">
<div class="w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
<p class="mt-4 text-gray-600 dark:text-gray-300">جاري تحميل الملفات...</p>
</div>
<!-- قائمة الملفات -->
<div class="hidden" id="fileContent">
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="fileGrid">
<!-- سيتم إضافة الملفات هنا -->
</div>
</div>
<!-- رسالة عند عدم وجود ملفات -->
<div class="hidden flex flex-col items-center justify-center py-16 text-center" id="emptyMessage">
<div class="text-6xl mb-4 text-gray-400 dark:text-gray-600">
<i class="fas fa-folder-open"></i>
</div>
<h2 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">المجلد فارغ</h2>
<p class="text-gray-500 dark:text-gray-400 max-w-md">لا توجد ملفات في هذا المجلد. يمكنك رفع ملفات جديدة باستخدام زر الرفع أعلاه.</p>
</div>
<!-- رسالة الخطأ -->
<div class="hidden flex flex-col items-center justify-center py-16 text-center" id="errorMessage">
<div class="text-6xl mb-4 text-error">
<i class="fas fa-exclamation-triangle"></i>
</div>
<h2 class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-2">حدث خطأ</h2>
<p class="text-gray-500 dark:text-gray-400 max-w-md">تعذر تحميل محتوى هذا المجلد. يرجى المحاولة مرة أخرى لاحقًا.</p>
<button class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors" id="retryButton">
<i class="fas fa-redo ml-1"></i>إعادة المحاولة
      </button>
</div>
<!-- مودال عرض الملف -->
<div class="fixed inset-0 bg-black/70 dark:bg-black/80 z-50 flex items-center justify-center hidden" id="fileViewerModal">
<div class="relative bg-white dark:bg-dark-surface rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
<div class="flex justify-between items-center p-4 border-b dark:border-dark-border">
<h3 class="font-bold text-lg" id="fileViewerTitle"></h3>
<button class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200" id="closeFileViewer">
<i class="fas fa-times text-xl"></i>
</button>
</div>
<div class="p-4 overflow-auto max-h-[calc(90vh-80px)]" id="fileViewerContent">
<!-- سيتم إضافة محتوى الملف هنا -->
</div>
<div class="p-4 border-t dark:border-dark-border flex justify-end">
<a class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors" download="" href="#" id="downloadFileLink">
<i class="fas fa-download ml-1"></i>تحميل الملف
          </a>
</div>
</div>
</div>
</main>
<!-- الفوتر -->
<footer class="bg-white dark:bg-dark-surface border-t dark:border-dark-border py-4 mt-auto">
<div class="container mx-auto px-4 text-center">
<p class="text-gray-600 dark:text-gray-400">© 2025 منصة التعليم الجزائري - جميع الحقوق محفوظة</p>
</div>
</footer>
<!-- دليل الأيقونات -->
<div class="fixed bottom-4 right-4 z-50" id="iconGuide">
<button class="bg-primary-600 hover:bg-primary-700 text-white p-3 rounded-full shadow-lg transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary-400 dark:focus:ring-primary-600">
<i class="fas fa-question"></i>
</button>
<div class="absolute bottom-full right-0 mb-2 w-64 p-4 bg-white dark:bg-dark-surface rounded-lg shadow-xl hidden transition-opacity" id="iconGuideContent">
<h3 class="font-bold mb-2 border-b pb-1 dark:border-dark-border">دليل الأيقونات</h3>
<ul class="text-sm space-y-2">
<li class="flex items-center"><i class="fas fa-folder text-yellow-500 ml-2"></i> مجلد</li>
<li class="flex items-center"><i class="fas fa-file-pdf text-red-500 ml-2"></i> ملف PDF</li>
<li class="flex items-center"><i class="fas fa-file-word text-blue-500 ml-2"></i> ملف Word</li>
<li class="flex items-center"><i class="fas fa-file-excel text-green-500 ml-2"></i> ملف Excel</li>
<li class="flex items-center"><i class="fas fa-file-powerpoint text-orange-500 ml-2"></i> ملف PowerPoint</li>
<li class="flex items-center"><i class="fas fa-file-image text-purple-500 ml-2"></i> صورة</li>
<li class="flex items-center"><i class="fas fa-file-alt text-gray-500 ml-2"></i> ملف نصي</li>
<li class="flex items-center"><i class="fas fa-file text-gray-400 ml-2"></i> ملف آخر</li>
</ul>
</div>
</div>
<script>
    // متغيرات التهيئة
    const username = "linnkou";
    const repo = "majani";
    const branch = "main";

    // الحصول على المسار
    const params = new URLSearchParams(window.location.search);
    const path = params.get("path") || "";
    
    // تحديد عناصر DOM
    const breadcrumb = document.getElementById("breadcrumb");
    const loadingState = document.getElementById("loadingState");
    const fileContent = document.getElementById("fileContent");
    const fileGrid = document.getElementById("fileGrid");
    const emptyMessage = document.getElementById("emptyMessage");
    const errorMessage = document.getElementById("errorMessage");
    const searchInput = document.getElementById("searchInput");
    const iconGuideButton = document.querySelector("#iconGuide button");
    const iconGuideContent = document.getElementById("iconGuideContent");
    const retryButton = document.getElementById("retryButton");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const uploadInput = document.getElementById("uploadInput");
    const fileNameDisplay = document.getElementById("fileNameDisplay");
    const uploadButton = document.getElementById("uploadButton");
    
    // عناصر DOM للمودال
    const fileViewerModal = document.getElementById("fileViewerModal");
    const fileViewerTitle = document.getElementById("fileViewerTitle");
    const fileViewerContent = document.getElementById("fileViewerContent");
    const closeFileViewer = document.getElementById("closeFileViewer");
    const downloadFileLink = document.getElementById("downloadFileLink");

    // تخزين بيانات الملفات والمجلدات
    let filesData = [];

    // دالة للتحقق من حالة تسجيل الدخول
    function isUserLoggedIn() {
      const user = JSON.parse(localStorage.getItem("currentUser") || "null");
      return user !== null;
    }

    // دالة للحصول على المسار الحالي
    function getCurrentPath() {
      return path || "";
    }

    // دالة رفع الملفات
    function uploadFileToCurrent() {
      const files = uploadInput.files;
      if (!files || files.length === 0) {
        showNotification("يرجى اختيار ملف أولاً", "error");
        return;
      }
      
      const user = JSON.parse(localStorage.getItem("currentUser") || "null");
      if (!user) {
        showNotification("يرجى تسجيل الدخول أولاً", "error");
        return;
      }

      // التحقق من امتدادات الملفات
      const validExtensions = ['.doc', '.docx', '.pdf', '.ppt', '.pptx', '.xls', '.xlsx', '.txt', '.jpg', '.jpeg', '.png', '.zip'];
      let invalidFiles = [];
      
      // عرض تأثير التحميل على الزر
      uploadButton.classList.add("opacity-70", "cursor-wait");
      uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري الرفع...';
      
      // تخزين الملفات
      const storedFiles = JSON.parse(localStorage.getItem("browserFiles") || "[]");
      let filesUploaded = 0;
      
      Array.from(files).forEach(file => {
        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!validExtensions.includes(fileExt)) {
          invalidFiles.push(file.name);
          return;
        }
        
        storedFiles.push({
          name: file.name,
          path: getCurrentPath(),
          approved: false,
          uploadedBy: user.username,
          timestamp: new Date().toISOString(),
          size: file.size
        });
        
        filesUploaded++;
      });
      
      // إظهار رسالة الخطأ إذا كانت هناك ملفات غير صالحة
      if (invalidFiles.length > 0) {
        showNotification(`الملفات التالية غير مدعومة: ${invalidFiles.join(', ')}`, "warning");
      }
      
      // حفظ الملفات ونظهر رسالة النجاح
      if (filesUploaded > 0) {
        localStorage.setItem("browserFiles", JSON.stringify(storedFiles));
        
        // إظهار رسالة النجاح
        setTimeout(() => {
          uploadButton.classList.remove("opacity-70", "cursor-wait");
          uploadButton.innerHTML = '<i class="fas fa-cloud-upload-alt ml-2"></i><span>رفع إلى هذا المجلد</span><div class="flames"></div>';
          
          const successMsg = filesUploaded === 1 
            ? "✅ تم رفع الملف بنجاح! بانتظار موافقة الأدمن."
            : `✅ تم رفع ${filesUploaded} ملفات بنجاح! بانتظار موافقة الأدمن.`;
          
          showNotification(successMsg, "success");
          
          // إعادة ضبط حقل الإدخال
          uploadInput.value = "";
          fileNameDisplay.textContent = "";
          
          // تحديث عرض الملفات التي تنتظر الموافقة
          displayPendingFiles();
        }, 1500);
      } else if (invalidFiles.length === files.length) {
        // كل الملفات غير صالحة
        uploadButton.classList.remove("opacity-70", "cursor-wait");
        uploadButton.innerHTML = '<i class="fas fa-cloud-upload-alt ml-2"></i><span>رفع إلى هذا المجلد</span><div class="flames"></div>';
      }
    }

    // عرض إشعار للمستخدم
    function showNotification(message, type = "info") {
      // إزالة الإشعارات السابقة
      const existingNotifications = document.querySelectorAll('.custom-notification');
      existingNotifications.forEach(notification => {
        notification.remove();
      });
      
      // إنشاء عنصر الإشعار
      const notification = document.createElement('div');
      notification.className = 'custom-notification fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
      
      // تعيين الألوان حسب النوع
      let icon, bgColor, textColor;
      switch(type) {
        case 'success':
          icon = 'fa-check-circle';
          bgColor = 'bg-green-600';
          textColor = 'text-white';
          break;
        case 'error':
          icon = 'fa-exclamation-circle';
          bgColor = 'bg-red-600';
          textColor = 'text-white';
          break;
        case 'warning':
          icon = 'fa-exclamation-triangle';
          bgColor = 'bg-yellow-500';
          textColor = 'text-white';
          break;
        default:
          icon = 'fa-info-circle';
          bgColor = 'bg-blue-600';
          textColor = 'text-white';
      }
      
      notification.classList.add(bgColor, textColor);
      notification.innerHTML = `
        <i class="fas ${icon} ml-2"></i>
        <span>${message}</span>
      `;
      
      // إضافة الإشعار إلى الصفحة
      document.body.appendChild(notification);
      
      // تأثير ظهور الإشعار
      setTimeout(() => {
        notification.style.opacity = '1';
      }, 10);
      
      // إزالة الإشعار بعد 3 ثوان
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }

    // عرض الملفات التي تنتظر الموافقة
    function displayPendingFiles() {
      const storedFiles = JSON.parse(localStorage.getItem("browserFiles") || "[]");
      const currentPathFiles = storedFiles.filter(file => file.path === getCurrentPath() && !file.approved);
      
      // إزالة قسم الملفات المعلقة إذا كان موجودًا
      const existingPendingSection = document.getElementById("pendingFilesSection");
      if (existingPendingSection) {
        existingPendingSection.remove();
      }
      
      // إذا كانت هناك ملفات معلقة، أنشئ قسمًا جديدًا لها
      if (currentPathFiles.length > 0) {
        const pendingSection = document.createElement("div");
        pendingSection.id = "pendingFilesSection";
        pendingSection.className = "container mx-auto mt-6 px-4 mb-6";
        pendingSection.innerHTML = `
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
            <h3 class="text-lg font-bold text-yellow-800 dark:text-yellow-300 mb-3 flex items-center">
              <i class="fas fa-clock mr-2"></i>
              ملفات بانتظار الموافقة (${currentPathFiles.length})
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3" id="pendingFilesList">
              ${currentPathFiles.map(file => `
                <div class="bg-white dark:bg-dark-surface border border-yellow-200 dark:border-yellow-800/50 rounded-lg p-3 flex items-center file-card">
                  <div class="${getFileIconAndColors({name: file.name, type: 'file'}).textColor} ml-3">
                    <i class="${getFileIconAndColors({name: file.name, type: 'file'}).icon} text-2xl"></i>
                  </div>
                  <div class="flex-1 overflow-hidden">
                    <h4 class="font-medium text-gray-800 dark:text-gray-200 truncate" title="${file.name}">${file.name}</h4>
                   <p class="text-xs text-gray-500 dark:text-gray-400">
  تم الرفع منذ ${getTimeAgo(file.timestamp)}
  <span class="bg-yellow-100 dark:bg-yellow-800/50 text-yellow-800 dark:text-yellow-300 text-xs px-2 py-0.5 rounded mr-1">قيد الانتظار</span>
</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        // إضافة القسم قبل قسم المحتوى الرئيسي
        document.querySelector("main").insertBefore(pendingSection, loadingState);
      }
    }

    // دالة للحصول على الوقت منذ تاريخ معين
    function getTimeAgo(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) {
        return "لحظات";
      } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return minutes + (minutes === 1 ? " دقيقة" : " دقائق");
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return hours + (hours === 1 ? " ساعة" : " ساعات");
      } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return days + (days === 1 ? " يوم" : " أيام");
      } else if (diffInSeconds < 31536000) {
        const months = Math.floor(diffInSeconds / 2592000);
        return months + (months === 1 ? " شهر" : " أشهر");
      } else {
        const years = Math.floor(diffInSeconds / 31536000);
        return years + (years === 1 ? " سنة" : " سنوات");
      }
    }

    // تحميل الملفات من GitHub API
    function loadFiles() {
      // إظهار حالة التحميل
      loadingState.classList.remove("hidden");
      fileContent.classList.add("hidden");
      emptyMessage.classList.add("hidden");
      errorMessage.classList.add("hidden");

      // إعداد مسار API
      const fullPath = "educationdzwordland/" + path;
      const encodedPath = fullPath.split("/").map(encodeURIComponent).join("/");
      const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${encodedPath}?ref=${branch}`;

      // إعداد مسار التنقل (breadcrumb)
      buildBreadcrumb();

      // جلب البيانات
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`استجابة غير ناجحة: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // إخفاء حالة التحميل
          loadingState.classList.add("hidden");
          
          if (!Array.isArray(data)) {
            // إذا كانت الاستجابة ليست مصفوفة، فهذا يعني أنها ملف واحد
            handleSingleFile(data);
            return;
          }

          // تصفية الملفات المخفية وتخزينها
          filesData = data.filter(item => !item.name.startsWith('.'));

          if (filesData.length === 0) {
            emptyMessage.classList.remove("hidden");
            return;
          }

          // عرض المحتوى
          fileContent.classList.remove("hidden");
          
          // فرز العناصر: المجلدات أولاً ثم الملفات، وكلاهما مرتب أبجديًا
          filesData.sort((a, b) => {
            if (a.type !== b.type) {
              return a.type === "dir" ? -1 : 1;
            }
            return a.name.localeCompare(b.name);
          });

          // عرض الملفات
          renderFiles(filesData);

          // إضافة معالج البحث
          setupSearch();
          
          // عرض الملفات التي تنتظر الموافقة
          displayPendingFiles();
        })
        .catch(error => {
          loadingState.classList.add("hidden");
          errorMessage.classList.remove("hidden");
          console.error("حدث خطأ:", error);
        });
    }

    // دالة لإنشاء مسار التنقل (breadcrumb)
    function buildBreadcrumb() {
      // مسح المحتوى السابق
      breadcrumb.innerHTML = `
        <a href="file-browser.html" class="flex items-center text-primary-600 dark:text-primary-400 hover:underline">
          <i class="fas fa-home ml-1"></i> الرئيسية
        </a>
      `;
      
      if (path) {
        const segments = path.split('/');
        let currentPath = '';
        
        segments.forEach((segment, index) => {
          if (!segment) return;
          
          currentPath += segment;
          
          const divider = document.createElement('span');
          divider.textContent = '/';
          divider.className = 'text-gray-400 mx-1';
          breadcrumb.appendChild(divider);
          
          const link = document.createElement('a');
          link.href = `file-browser.html?path=${currentPath}`;
          link.className = index === segments.length - 1 
            ? 'text-gray-800 dark:text-gray-200 font-medium' 
            : 'text-primary-600 dark:text-primary-400 hover:underline';
          link.textContent = segment;
          breadcrumb.appendChild(link);
          
          currentPath += '/';
        });
      }
    }

    // دالة لعرض الملفات والمجلدات
    function renderFiles(files) {
      fileGrid.innerHTML = '';
      
      files.forEach(item => {
        const { icon, textColor, bgColor } = getFileIconAndColors(item);
        
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-lg overflow-hidden file-card hover:border-primary-400 dark:hover:border-primary-600 transition-all shadow-sm hover:shadow';
        
        const isDirectory = item.type === 'dir';
        const dateModified = new Date(item.last_modified || item.created_at || new Date());
        
        card.innerHTML = `
          <div class="flex items-center p-4">
            <div class="${bgColor} w-10 h-10 flex items-center justify-center rounded-lg ml-3">
              <i class="fas ${icon} ${textColor} text-xl"></i>
            </div>
            <div class="flex-grow min-w-0">
              <h3 class="font-medium text-gray-800 dark:text-gray-200 truncate" title="${item.name}">${item.name}</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                ${isDirectory ? 'مجلد' : formatFileSize(item.size)}
                <span class="mx-1">•</span>
                ${formatDate(dateModified)}
              </p>
            </div>
          </div>
          <div class="bg-gray-50 dark:bg-dark-surface border-t dark:border-dark-border px-4 py-2 flex justify-end">
            ${isDirectory ? 
              `<a href="file-browser.html?path=${path ? path + '/' : ''}${item.name}" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 flex items-center text-sm">
                <span>فتح</span>
                <i class="fas fa-chevron-left mr-1"></i>
              </a>` : 
              `<button class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300 flex items-center text-sm view-file-btn" data-filename="${item.name}" data-download-url="${item.download_url}">
                <span>عرض</span>
                <i class="fas fa-eye mr-1"></i>
              </button>`
            }
          </div>
        `;
        
        fileGrid.appendChild(card);
      });
      
      // إضافة أحداث النقر على أزرار عرض الملف
      document.querySelectorAll('.view-file-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const fileName = btn.getAttribute('data-filename');
          const downloadUrl = btn.getAttribute('data-download-url');
          viewFile({ name: fileName, download_url: downloadUrl });
        });
      });
    }

    // دالة لتنسيق حجم الملف
    function formatFileSize(bytes) {
      if (!bytes) return 'غير معروف';
      if (bytes === 0) return '0 بايت';
      
      const sizes = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت', 'تيرابايت'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      
      return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // دالة لتنسيق التاريخ
    function formatDate(date) {
      return date.toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // دالة للحصول على أيقونة وألوان الملف المناسبة
    function getFileIconAndColors(item) {
      let icon = 'fa-file';
      let textColor = 'text-gray-400';
      let bgColor = 'bg-gray-100 dark:bg-gray-800';
      
      if (item.type === 'dir') {
        icon = 'fa-folder';
        textColor = 'text-yellow-500';
        bgColor = 'bg-yellow-100 dark:bg-yellow-900/30';
      } else if (item.name) {
        const ext = item.name.split('.').pop().toLowerCase();
        
        if (['pdf'].includes(ext)) {
          icon = 'fa-file-pdf';
          textColor = 'text-red-500';
          bgColor = 'bg-red-100 dark:bg-red-900/30';
        } else if (['doc', 'docx'].includes(ext)) {
          icon = 'fa-file-word';
          textColor = 'text-blue-500';
          bgColor = 'bg-blue-100 dark:bg-blue-900/30';
        } else if (['xls', 'xlsx'].includes(ext)) {
          icon = 'fa-file-excel';
          textColor = 'text-green-500';
          bgColor = 'bg-green-100 dark:bg-green-900/30';
        } else if (['ppt', 'pptx'].includes(ext)) {
          icon = 'fa-file-powerpoint';
          textColor = 'text-orange-500';
          bgColor = 'bg-orange-100 dark:bg-orange-900/30';
        } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
          icon = 'fa-file-image';
          textColor = 'text-purple-500';
          bgColor = 'bg-purple-100 dark:bg-purple-900/30';
        } else if (['txt', 'md'].includes(ext)) {
          icon = 'fa-file-alt';
          textColor = 'text-gray-500';
          bgColor = 'bg-gray-100 dark:bg-gray-800';
        } else if (['zip', 'rar', '7z'].includes(ext)) {
          icon = 'fa-file-archive';
          textColor = 'text-amber-600';
          bgColor = 'bg-amber-100 dark:bg-amber-900/30';
        }
      }
      
      return { icon, textColor, bgColor };
    }

    // معالجة ملف وحيد (عرض المودال)
    function handleSingleFile(file) {
      showFileViewer(file);
    }

    // إعداد وظيفة البحث
    function setupSearch() {
      searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        
        if (query === '') {
          renderFiles(filesData);
          return;
        }
        
        const filteredFiles = filesData.filter(item => 
          item.name.toLowerCase().includes(query)
        );
        
        if (filteredFiles.length === 0) {
          fileGrid.innerHTML = `
            <div class="col-span-full text-center py-8">
              <div class="text-4xl mb-3 text-gray-400 dark:text-gray-600">
                <i class="fas fa-search"></i>
              </div>
              <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-1">لا توجد نتائج مطابقة</h3>
              <p class="text-gray-500 dark:text-gray-400">لم يتم العثور على ملفات أو مجلدات تطابق كلمة البحث "${query}"</p>
            </div>
          `;
        } else {
          renderFiles(filteredFiles);
        }
      });
    }

    // عرض مودال عارض الملفات
    function viewFile(item) {
      // تعيين عنوان الملف
      fileViewerTitle.textContent = item.name;
      
      // تحديد رابط التحميل
      downloadFileLink.href = item.download_url;
      downloadFileLink.setAttribute('download', item.name);
      
      // تحديد محتوى العارض حسب نوع الملف
      setFileViewerContent(item);
      
      // إظهار المودال
      fileViewerModal.classList.remove('hidden');
      
      // منع التمرير في الصفحة الرئيسية
      document.body.style.overflow = 'hidden';
    }

    // تعيين محتوى عارض الملفات بناءً على نوع الملف
    function setFileViewerContent(item) {
      // مسح المحتوى السابق
      fileViewerContent.innerHTML = '';
      
      // عرض حالة التحميل
      fileViewerContent.innerHTML = `
        <div class="flex flex-col items-center justify-center py-8">
          <div class="w-12 h-12 border-4 border-primary-600 border-t-transparent rounded-full animate-spin"></div>
          <p class="mt-4 text-gray-600 dark:text-gray-300">جاري تحميل محتوى الملف...</p>
        </div>
      `;
      
      const extension = item.name.split('.').pop().toLowerCase();
      
      // عرض الملف حسب نوعه
      if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
        // صور
        const img = document.createElement('img');
        img.src = item.download_url;
        img.className = 'max-w-full h-auto mx-auto';
        img.alt = item.name;
        
        img.onload = () => {
          fileViewerContent.innerHTML = '';
          fileViewerContent.appendChild(img);
        };
        
        img.onerror = () => {
          fileViewerContent.innerHTML = `
            <div class="text-center py-8">
              <div class="text-4xl mb-4 text-error">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <p>تعذر تحميل الصورة. يرجى تجربة تحميل الملف مباشرة.</p>
            </div>
          `;
        };
      } else if (['pdf'].includes(extension)) {
        // ملفات PDF
        fileViewerContent.innerHTML = `
          <div class="flex flex-col h-[500px]">
            <iframe src="${item.download_url}" class="w-full h-full rounded border dark:border-dark-border"></iframe>
          </div>
        `;
      } else if (['txt', 'md', 'json', 'xml', 'csv', 'html', 'css', 'js'].includes(extension)) {
        // ملفات نصية
        fetch(item.download_url)
          .then(response => response.text())
          .then(text => {
            fileViewerContent.innerHTML = `
              <pre class="bg-gray-100 dark:bg-gray-800 p-4 rounded overflow-x-auto whitespace-pre-wrap">${escapeHtml(text)}</pre>
            `;
          })
          .catch(() => {
            fileViewerContent.innerHTML = `
              <div class="text-center py-8">
                <div class="text-4xl mb-4 text-error">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <p>تعذر تحميل محتوى الملف. يرجى تجربة تحميل الملف مباشرة.</p>
              </div>
            `;
          });
      } else {
        // أنواع أخرى من الملفات
        fileViewerContent.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4 ${getFileIconAndColors(item).textColor}">
              <i class="${getFileIconAndColors(item).icon}"></i>
            </div>
            <p class="text-xl font-bold mb-2">${item.name}</p>
            <p class="mb-4">هذا النوع من الملفات لا يمكن عرضه مباشرة. يرجى تحميل الملف لعرضه.</p>
          </div>
        `;
      }
    }

    // تهريب النص HTML
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // إعداد معالجات الأحداث
    function setupEventListeners() {
      // زر إعادة المحاولة
      retryButton.addEventListener('click', loadFiles);
      
      // زر تبديل الوضع المظلم
      darkModeToggle.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      });
      
      // دليل الأيقونات
      iconGuideButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        iconGuideContent.classList.toggle('hidden');
      });
      
      // إخفاء دليل الأيقونات عند النقر خارجه
      document.addEventListener('click', (e) => {
        if (!iconGuide.contains(e.target)) {
          iconGuideContent.classList.add('hidden');
        }
      });
      
      // إغلاق مودال عارض الملفات
      closeFileViewer.addEventListener('click', () => {
        fileViewerModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      });
      
      // إغلاق المودال عند النقر خارج المحتوى
      fileViewerModal.addEventListener('click', (e) => {
        if (e.target === fileViewerModal) {
          fileViewerModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
      
      // إغلاق المودال بزر Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !fileViewerModal.classList.contains('hidden')) {
          fileViewerModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
      
      // تحديث عرض اسم الملف عند اختياره
      uploadInput.addEventListener('change', () => {
        const files = uploadInput.files;
        if (files.length > 0) {
          fileNameDisplay.textContent = files.length === 1 
            ? files[0].name
            : `تم اختيار ${files.length} ملفات`;
        } else {
          fileNameDisplay.textContent = '';
        }
      });
    }

    // تسجيل الخروج
    function logoutUser() {
      localStorage.removeItem("currentUser");
      window.location.href = "login.html";
    }

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      // التحقق من تسجيل الدخول
      const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const found = currentUser ? users.find(u => u.username === currentUser.username && u.password === currentUser.password) : null;
      const isAdmin = currentUser && currentUser.username === "latifking" && currentUser.password === "ding2010";

      if (!found && !isAdmin) {
        window.location.href = "login.html";
      } else if (found && !found.approved) {
        window.location.href = "not-approved.html";
      }

      // إضافة زر تسجيل الخروج
      const logoutBtn = document.createElement('div');
      logoutBtn.style.position = 'fixed';
      logoutBtn.style.top = '20px';
      logoutBtn.style.left = '20px';
      logoutBtn.style.zIndex = '999';
      logoutBtn.innerHTML = `
        <button onclick="logoutUser()" style="padding: 10px 20px; background: #F44336; color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">تسجيل الخروج</button>
      `;
      document.body.appendChild(logoutBtn);

      // التحقق من وضع السمة الداكنة
      if (localStorage.getItem('color-theme') === 'dark' || 
          (!localStorage.getItem('color-theme') && 
           window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }
      
      // إعداد معالجات الأحداث
      setupEventListeners();
      
      // تحميل الملفات
      loadFiles();
    });
</script>
</body>
</html>