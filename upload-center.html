<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📤 مركز رفع الملفات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary-color: #0072ff;
      --primary-hover: #005fcc;
      --bg-light: #f5f7f9;
      --card-bg-light: white;
      --text-color-light: #333;
      --input-border-light: #ccc;
      --success-color: #4CAF50;
      --warning-color: #ff9800;
      --error-color: #f44336;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --primary-color: #5D5CDE;
        --primary-hover: #4a49c0;
        --bg-light: #181818;
        --card-bg-light: #242424;
        --text-color-light: #e0e0e0;
        --input-border-light: #444;
      }
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #83a4d4, #b6fbff);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: var(--text-color-light);
      background-color: var(--bg-light);
    }
    
    .dark body {
      background: linear-gradient(to right, #121212, #1f1f1f);
    }
    
    .card {
      background-color: var(--card-bg-light);
      border-radius: 12px;
      padding: 30px;
      width: 100%;
      max-width: 600px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    select, input[type="file"], input[type="text"], button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid var(--input-border-light);
      font-size: 15px;
      background-color: var(--card-bg-light);
      color: var(--text-color-light);
    }
    
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%23666" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: left 12px center;
      background-size: 20px;
      padding-left: 40px;
    }
    
    select:disabled {
      background-color: rgba(0,0,0,0.05);
      cursor: not-allowed;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    #msg {
      text-align: center;
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    
    .success {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
      border: 1px solid rgba(76, 175, 80, 0.2);
    }
    
    .warning {
      background-color: rgba(255, 152, 0, 0.1);
      color: var(--warning-color);
      border: 1px solid rgba(255, 152, 0, 0.2);
    }
    
    .error {
      background-color: rgba(244, 67, 54, 0.1);
      color: var(--error-color);
      border: 1px solid rgba(244, 67, 54, 0.2);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .upload-path {
      background-color: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      font-family: monospace;
      word-break: break-all;
    }
    
    .upload-path-label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .nav-btn {
      padding: 10px 15px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .nav-btn:hover {
      background-color: var(--primary-hover);
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>📤 مركز رفع الملفات</h2>
    
    <label for="phase">الطور التعليمي:</label>
    <select id="phase" onchange="loadYears()">
      <option value="">-- اختر الطور --</option>
      <option value="الطور الإبتدائي">الطور الإبتدائي</option>
      <option value="الطور المتوسط">الطور المتوسط</option>
      <option value="الطور الثانوي">الطور الثانوي</option>
    </select>

    <label for="year">السنة الدراسية:</label>
    <select id="year" onchange="loadSubjects()" disabled>
      <option value="">-- اختر السنة --</option>
    </select>

    <label for="subject">المادة الدراسية:</label>
    <select id="subject" onchange="loadSubfolders()" disabled>
      <option value="">-- اختر المادة --</option>
    </select>
    
    <label for="customSubject">أو أدخل اسم مادة جديدة:</label>
    <input type="text" id="customSubject" placeholder="(اختياري) أدخل اسم مادة جديدة" />

    <label for="subfolder">المجلد الفرعي:</label>
    <select id="subfolder" disabled>
      <option value="">-- بدون مجلد فرعي --</option>
    </select>
    
    <label for="customSubfolder">أو أضف مجلدًا فرعيًا جديدًا:</label>
    <input type="text" id="customSubfolder" placeholder="(اختياري) أدخل اسم مجلد فرعي جديد" />

    <label for="type">نوع الملف:</label>
    <select id="type">
      <option value="فرض">فرض</option>
      <option value="اختبار">اختبار</option>
      <option value="مراجعة">مراجعة</option>
      <option value="درس">درس</option>
      <option value="مذكرة">مذكرة</option>
      <option value="ملخص">ملخص</option>
      <option value="تمارين">تمارين</option>
      <option value="واجب">واجب منزلي</option>
      <option value="أخرى">أخرى</option>
    </select>

    <div id="uploadPathContainer" class="hidden">
      <div class="upload-path-label">مسار الرفع:</div>
      <div id="uploadPath" class="upload-path"></div>
    </div>

    <input type="file" id="fileInput" />
    <button id="uploadBtn" onclick="upload()">رفع الملف</button>
    <div id="msg"></div>
    
    <div class="navigation-buttons">
      <a href="home.html" class="nav-btn">🏠 العودة للرئيسية</a>
    </div>
  </div>

  <script>
    // التحقق من وضع الظلام
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
  
    // الثوابت والمتغيرات
    const token = localStorage.getItem("github_token");
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const loggedUser = JSON.parse(localStorage.getItem("loggedUser") || "null");
    const repo = "majani";
    const owner = "linnkou";
    const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;
    
    // التحقق من تسجيل الدخول
    if (!isAdmin && !loggedUser) {
      window.location.href = "login.html";
    }
    
    // العناصر المرجعية في واجهة المستخدم
    const phaseSelect = document.getElementById("phase");
    const yearSelect = document.getElementById("year");
    const subjectSelect = document.getElementById("subject");
    const customSubjectInput = document.getElementById("customSubject");
    const subfolderSelect = document.getElementById("subfolder");
    const customSubfolderInput = document.getElementById("customSubfolder");
    const typeSelect = document.getElementById("type");
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const msgDiv = document.getElementById("msg");
    const uploadPathContainer = document.getElementById("uploadPathContainer");
    const uploadPathDiv = document.getElementById("uploadPath");
    
    // تحميل السنوات الدراسية بناءً على الطور المختار
    async function loadYears() {
      const phase = phaseSelect.value;
      
      // إعادة تعيين التحديد
      resetSelect(yearSelect, "-- اختر السنة --");
      resetSelect(subjectSelect, "-- اختر المادة --");
      resetSelect(subfolderSelect, "-- بدون مجلد فرعي --");
      
      if (!phase) {
        yearSelect.disabled = true;
        return;
      }
      
      try {
        // عرض حالة التحميل
        showMessage("جاري تحميل السنوات الدراسية...", "loading");
        yearSelect.disabled = true;
        
        // جلب قائمة السنوات من خلال API
        const response = await fetch(`${apiBase}/data/${phase}`, {
          headers: { 
            Accept: "application/vnd.github.v3+json",
            Authorization: token ? `token ${token}` : undefined
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            // إنشاء المجلد إذا لم يكن موجودًا (للأدمين فقط)
            if (isAdmin) {
              await createFolder(`data/${phase}`);
              yearSelect.disabled = false;
              showMessage("تم إنشاء مجلد الطور بنجاح، يمكنك الآن إضافة سنة دراسية.", "success");
            } else {
              showMessage("الطور غير موجود. يرجى التواصل مع المسؤول.", "error");
            }
            return;
          }
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const directories = await response.json();
        
        // تصفية المجلدات
        const folders = directories.filter(item => item.type === "dir");
        
        if (folders.length === 0) {
          showMessage("لا توجد سنوات دراسية متاحة بعد في هذا الطور.", "warning");
        } else {
          // إضافة السنوات إلى القائمة المنسدلة
          folders.forEach(folder => {
            const option = document.createElement("option");
            option.value = folder.name;
            option.textContent = folder.name.replace(/-/g, " ");
            yearSelect.appendChild(option);
          });
          
          clearMessage();
        }
      } catch (error) {
        console.error("Error loading years:", error);
        showMessage("حدث خطأ أثناء تحميل السنوات الدراسية.", "error");
      } finally {
        yearSelect.disabled = false;
        updateUploadPath();
      }
    }
    
    // تحميل المواد الدراسية بناءً على السنة المختارة
    async function loadSubjects() {
      const phase = phaseSelect.value;
      const year = yearSelect.value;
      
      // إعادة تعيين التحديد
      resetSelect(subjectSelect, "-- اختر المادة --");
      resetSelect(subfolderSelect, "-- بدون مجلد فرعي --");
      
      if (!phase || !year) {
        subjectSelect.disabled = true;
        return;
      }
      
      try {
        // عرض حالة التحميل
        showMessage("جاري تحميل المواد الدراسية...", "loading");
        subjectSelect.disabled = true;
        
        // جلب قائمة المواد من خلال API
        const response = await fetch(`${apiBase}/data/${phase}/${year}`, {
          headers: { 
            Accept: "application/vnd.github.v3+json",
            Authorization: token ? `token ${token}` : undefined
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            // إنشاء المجلد إذا لم يكن موجودًا (للأدمين فقط)
            if (isAdmin) {
              await createFolder(`data/${phase}/${year}`);
              subjectSelect.disabled = false;
              showMessage("تم إنشاء مجلد السنة الدراسية بنجاح، يمكنك الآن إضافة مادة دراسية.", "success");
            } else {
              showMessage("السنة الدراسية غير موجودة. يرجى التواصل مع المسؤول.", "error");
            }
            return;
          }
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const directories = await response.json();
        
        // تصفية المجلدات
        const folders = directories.filter(item => item.type === "dir");
        
        if (folders.length === 0) {
          showMessage("لا توجد مواد دراسية متاحة بعد في هذه السنة.", "warning");
        } else {
          // إضافة المواد إلى القائمة المنسدلة
          folders.forEach(folder => {
            const option = document.createElement("option");
            option.value = folder.name;
            option.textContent = folder.name.replace(/-/g, " ");
            subjectSelect.appendChild(option);
          });
          
          clearMessage();
        }
      } catch (error) {
        console.error("Error loading subjects:", error);
        showMessage("حدث خطأ أثناء تحميل المواد الدراسية.", "error");
      } finally {
        subjectSelect.disabled = false;
        updateUploadPath();
      }
    }
    
    // تحميل المجلدات الفرعية بناءً على المادة المختارة
    async function loadSubfolders() {
      const phase = phaseSelect.value;
      const year = yearSelect.value;
      const subject = subjectSelect.value;
      
      // إعادة تعيين التحديد
      resetSelect(subfolderSelect, "-- بدون مجلد فرعي --");
      
      if (!phase || !year || !subject) {
        subfolderSelect.disabled = true;
        return;
      }
      
      try {
        // عرض حالة التحميل
        showMessage("جاري تحميل المجلدات الفرعية...", "loading");
        subfolderSelect.disabled = true;
        
        // جلب قائمة المجلدات الفرعية من خلال API
        const response = await fetch(`${apiBase}/data/${phase}/${year}/${subject}`, {
          headers: { 
            Accept: "application/vnd.github.v3+json",
            Authorization: token ? `token ${token}` : undefined
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            // إنشاء المجلد إذا لم يكن موجودًا (للأدمين فقط)
            if (isAdmin) {
              await createFolder(`data/${phase}/${year}/${subject}`);
              subfolderSelect.disabled = false;
              showMessage("تم إنشاء مجلد المادة الدراسية بنجاح، يمكنك الآن إضافة ملفات.", "success");
            } else {
              showMessage("المادة الدراسية غير موجودة. يرجى التواصل مع المسؤول.", "error");
            }
            return;
          }
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const directories = await response.json();
        
        // تصفية المجلدات
        const folders = directories.filter(item => item.type === "dir");
        
        if (folders.length === 0) {
          showMessage("لا توجد مجلدات فرعية متاحة بعد لهذه المادة.", "info");
        } else {
          // إضافة المجلدات الفرعية إلى القائمة المنسدلة
          folders.forEach(folder => {
            const option = document.createElement("option");
            option.value = folder.name;
            option.textContent = folder.name.replace(/-/g, " ");
            subfolderSelect.appendChild(option);
          });
          
          clearMessage();
        }
      } catch (error) {
        console.error("Error loading subfolders:", error);
        showMessage("حدث خطأ أثناء تحميل المجلدات الفرعية.", "error");
      } finally {
        subfolderSelect.disabled = false;
        updateUploadPath();
      }
    }
    
    // إنشاء مجلد جديد
    async function createFolder(path) {
      try {
        // إنشاء ملف .gitkeep لإنشاء المجلد
        const response = await fetch(`${apiBase}/${path}/.gitkeep`, {
          method: "PUT",
          headers: {
            Accept: "application/vnd.github.v3+json",
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `إنشاء مجلد: ${path}`,
            content: "IyBJZ25vcmUgdGhpcyBmaWxlCg==", // base64 encoded "# Ignore this file"
            branch: "main"
          })
        });
        
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error("Error creating folder:", error);
        throw error;
      }
    }
    
    // عملية رفع الملف
    async function upload() {
      // جمع البيانات من النموذج
      const phase = phaseSelect.value;
      const year = yearSelect.value;
      const subject = subjectSelect.value;
      const customSubject = customSubjectInput.value.trim().replace(/\s+/g, "-");
      const subfolder = subfolderSelect.value;
      const customSubfolder = customSubfolderInput.value.trim().replace(/\s+/g, "-");
      const type = typeSelect.value;
      const file = fileInput.files[0];
      
      // التحقق من صحة البيانات
      if (!phase) {
        return showMessage("يرجى اختيار الطور التعليمي.", "error");
      }
      
      if (!year) {
        return showMessage("يرجى اختيار السنة الدراسية.", "error");
      }
      
      const finalSubject = customSubject || subject;
      if (!finalSubject) {
        return showMessage("يرجى اختيار المادة الدراسية أو إدخال اسم مادة جديدة.", "error");
      }
      
      if (!file) {
        return showMessage("يرجى اختيار ملف للرفع.", "error");
      }
      
      // إنشاء مسار الرفع
      let folderPath = `data/${phase}/${year}/${finalSubject}`;
      const finalSubfolder = customSubfolder || subfolder;
      
      if (finalSubfolder) {
        folderPath += `/${finalSubfolder}`;
      }
      
      // إنشاء اسم الملف النهائي
      const fileName = `${type}-${file.name}`;
      const fullFilePath = `${folderPath}/${fileName}`;
      
      // تحديد المسار النهائي للرفع (مباشرة للأدمين، أو قيد الانتظار للمستخدمين العاديين)
      const uploadPath = isAdmin ? fullFilePath : `pending_uploads/${fileName}`;
      
      try {
        // عرض حالة التحميل
        showMessage("جاري رفع الملف...", "loading");
        uploadBtn.disabled = true;
        
        // قراءة محتوى الملف
        const content = await readFileAsBase64(file);
        
        // رفع الملف إلى GitHub
        const response = await fetch(`${apiBase}/${uploadPath}`, {
          method: "PUT",
          headers: {
            Accept: "application/vnd.github.v3+json",
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `رفع ملف من مركز الرفع: ${fileName}`,
            content: content,
            branch: "main"
          })
        });
        
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }
        
        // نجاح العملية
        if (isAdmin) {
          showMessage(`تم رفع الملف بنجاح إلى: ${folderPath}`, "success");
        } else {
          showMessage("تم رفع الملف بنجاح. سيتم مراجعته من قبل المسؤول.", "success");
        }
        
        // إعادة تعيين النموذج
        fileInput.value = "";
      } catch (error) {
        console.error("Error uploading file:", error);
        showMessage("حدث خطأ أثناء رفع الملف. يرجى المحاولة مرة أخرى.", "error");
      } finally {
        uploadBtn.disabled = false;
      }
    }
    
    // قراءة الملف كـ Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const content = reader.result.split(',')[1]; // استخراج جزء البيانات من URL البيانات
          resolve(content);
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // إعادة تعيين القائمة المنسدلة
    function resetSelect(selectElement, defaultOption) {
      selectElement.innerHTML = '';
      const option = document.createElement("option");
      option.value = "";
      option.textContent = defaultOption;
      selectElement.appendChild(option);
      selectElement.disabled = true;
    }
    
    // تحديث عرض مسار الرفع
    function updateUploadPath() {
      const phase = phaseSelect.value;
      const year = yearSelect.value;
      const subject = subjectSelect.value || customSubjectInput.value.trim();
      const subfolder = subfolderSelect.value || customSubfolderInput.value.trim();
      const type = typeSelect.value;
      
      if (phase || year || subject) {
        let path = "data";
        
        if (phase) path += `/${phase}`;
        if (year) path += `/${year}`;
        if (subject) path += `/${subject}`;
        if (subfolder) path += `/${subfolder}`;
        if (type && fileInput.files.length > 0) {
          path += `/${type}-${fileInput.files[0].name}`;
        }
        
        uploadPathDiv.textContent = path;
        uploadPathContainer.classList.remove("hidden");
      } else {
        uploadPathContainer.classList.add("hidden");
      }
    }
    
    // عرض رسالة للمستخدم
    function showMessage(message, type) {
      msgDiv.textContent = '';
      msgDiv.className = '';
      
      if (type === "loading") {
        const loader = document.createElement("span");
        loader.className = "loading";
        msgDiv.appendChild(loader);
        msgDiv.appendChild(document.createTextNode(message));
      } else {
        msgDiv.textContent = message;
        msgDiv.classList.add(type);
      }
    }
    
    // مسح الرسالة
    function clearMessage() {
      msgDiv.textContent = '';
      msgDiv.className = '';
    }
    
    // مستمعو الأحداث لتحديث مسار الرفع
    phaseSelect.addEventListener("change", updateUploadPath);
    yearSelect.addEventListener("change", updateUploadPath);
    subjectSelect.addEventListener("change", updateUploadPath);
    subfolderSelect.addEventListener("change", updateUploadPath);
    customSubjectInput.addEventListener("input", updateUploadPath);
    customSubfolderInput.addEventListener("input", updateUploadPath);
    typeSelect.addEventListener("change", updateUploadPath);
    fileInput.addEventListener("change", updateUploadPath);
  </script>
</body>
</html>