
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #4facfe, #00f2fe);
      color: #333;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #0072ff;
      margin-bottom: 20px;
    }
    .admin-tools {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 15px;
      border-radius: 6px;
    }
    input {
      border: 1px solid #ccc;
    }
    button {
      background: #0072ff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #005fcc;
    }
    ul {
      list-style: none;
      padding-right: 20px;
    }
    li {
      margin-bottom: 6px;
    }
    .file {
      color: #444;
    }
    .folder {
      font-weight: bold;
      color: #0072ff;
      cursor: pointer;
    }
    .pending {
      background-color: #ffe5b4;
      padding: 5px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“‚ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</h2>
  <div class="admin-tools">
    <label>ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø±Ø¦ÙŠØ³ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¯Ø§Ø®Ù„ data/</label>
    <input type="text" id="newFolderName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
    <button onclick="createFolder()">â• Ø¥Ù†Ø´Ø§Ø¡</button>
    <p id="createMsg"></p>

    <hr />

    <h3>ğŸ“ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
    <div id="tree">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>

  <script>
    const token = localStorage.getItem("github_token");
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const repo = "majani";
    const owner = "linnkou";
    const apiBase = `https://api.github.com/repos/${owner}/${repo}/contents`;

    if (!isAdmin || !token) {
      alert("ğŸ” Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø£Ø¯Ù…ÙŠÙ† ÙÙ‚Ø·.");
      window.location.href = "index.html";
    }

    async function createFolder() {
      const name = document.getElementById("newFolderName").value.trim().replace(/\s+/g, "-");
      const msg = document.getElementById("createMsg");
      if (!name) return msg.innerText = "â— Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ ØµØ§Ù„Ø­Ù‹Ø§.";

      const res = await fetch(`${apiBase}/data/${name}/.gitkeep`, {
        method: "PUT",
        headers: {
          Authorization: "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯: ${name}`,
          content: "",
          branch: "main"
        })
      });

      if (res.ok) {
        msg.innerText = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¨Ù†Ø¬Ø§Ø­.";
        loadTree("data", document.getElementById("tree"));
      } else {
        const err = await res.json();
        msg.innerText = "âŒ ÙØ´Ù„: " + err.message;
      }
    }

    async function loadTree(path, container) {
      const res = await fetch(`${apiBase}/${path}`, {
        headers: { Authorization: "token " + token }
      });
      const data = await res.json();
      container.innerHTML = "";
      const ul = document.createElement("ul");

      data.forEach(item => {
        const li = document.createElement("li");
        if (item.type === "dir") {
          li.innerHTML = `ğŸ“ <span class="folder" onclick="loadTree('${item.path}', this)"> ${item.name}</span>`;
        } else {
          const fileLink = `https://linnkou.github.io/majani/${item.path}`;
          li.innerHTML = `ğŸ“„ <a class="file" href="${fileLink}" target="_blank">${item.name}</a>`;
        }
        ul.appendChild(li);
      });

      container.appendChild(ul);
    }

    loadTree("data", document.getElementById("tree"));
  </script>
</body>

<script>
  async function loadPendingFiles() {
    const pendingDiv = document.getElementById("pending");
    const res = await fetch(`${apiBase}/pending_uploads`, {
      headers: { Authorization: "token " + token }
    });
    const files = await res.json();
    if (!Array.isArray(files)) {
      pendingDiv.innerText = "âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª.";
      return;
    }
    if (files.length === 0) {
      pendingDiv.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§.";
      return;
    }
    const ul = document.createElement("ul");
    files.forEach(file => {
      const li = document.createElement("li");
      const fileName = file.name;
      const filePath = file.path;
      li.innerHTML = `ğŸ“„ <a href="https://linnkou.github.io/majani/${filePath}" target="_blank">${fileName}</a>
        <button onclick="approveFile('${filePath}')">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button onclick="deleteFile('${filePath}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>`;
      ul.appendChild(li);
    });
    pendingDiv.appendChild(ul);
  }

  async function approveFile(path) {
    const target = prompt("ğŸ“‚ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (Ù…Ø«Ø§Ù„: data/primary/Ø§Ù„Ø³Ù†Ø©-Ø§Ù„Ø«Ø§Ù„Ø«Ø©/Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª):");
    if (!target) return;
    const fileName = path.split("/").pop();
    const res = await fetch(`${apiBase}/${path}`, {
      headers: { Authorization: "token " + token }
    });
    const file = await res.json();
    const content = file.content;
    const decoded = content;

    const uploadRes = await fetch(`${apiBase}/${target}/${fileName}`, {
      method: "PUT",
      headers: {
        Authorization: "token " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù ÙˆÙ†Ù‚Ù„Ù‡",
        content: decoded,
        branch: "main"
      })
    });

    if (uploadRes.ok) {
      await deleteFile(path, true);
      alert("âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙ… Ø§Ù„Ù†Ù‚Ù„!");
      location.reload();
    } else {
      alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ù‚Ù„.");
    }
  }

  async function deleteFile(path, silent = false) {
    const res = await fetch(`${apiBase}/${path}`, {
      headers: { Authorization: "token " + token }
    });
    const file = await res.json();
    const sha = file.sha;
    const delRes = await fetch(`${apiBase}/${path}`, {
      method: "DELETE",
      headers: {
        Authorization: "token " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Ø­Ø°Ù Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø§Øª",
        sha: sha,
        branch: "main"
      })
    });
    if (!silent) {
      if (delRes.ok) {
        alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­.");
        location.reload();
      } else {
        alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù.");
      }
    }
  }

  loadPendingFiles();
</script>
</html>

