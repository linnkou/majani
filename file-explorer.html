
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>استعراض الملفات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
    ul { list-style: none; padding-right: 20px; }
    li { margin-bottom: 10px; cursor: pointer; }
    .folder { font-weight: bold; color: #1e88e5; }
    .file { color: #555; }
    #uploadSection { margin-top: 20px; display: none; }
    #searchInput { margin: 20px 0; padding: 8px; width: 100%; font-size: 16px; }
  </style>
</head>
<body>
  <h2>📁 استعراض الملفات التعليمية</h2>

  <input type="text" id="searchInput" placeholder="🔍 ابحث عن ملف..." onkeyup="filterFiles()" />

  <div id="uploadSection">
    <h3>📤 رفع ملف في هذا المجلد</h3>
    <input type="file" id="uploadFile" />
    <button onclick="uploadFile()">رفع</button>
    <p id="uploadMsg"></p>
  </div>

  <div id="explorer">جاري تحميل المحتوى...</div>

  <script>
    const repo = "majani";
    const owner = "linnkou";
    const branch = "main";
    const apiBase = "https://api.github.com/repos/" + owner + "/" + repo + "/contents/";
    const ghPagesBase = "https://linnkou.github.io/majani/";
    const isAdmin = localStorage.getItem("isAdmin") === "true";
    const token = localStorage.getItem("github_token");
    let currentPath = "data";

    if (isAdmin) {
      document.getElementById("uploadSection").style.display = "block";
    }

    async function loadFolder(path = "data", container = document.getElementById('explorer')) {
      currentPath = path;
      const res = await fetch(apiBase + path);
      const data = await res.json();
      container.innerHTML = "";
      const ul = document.createElement('ul');
      ul.id = "fileList";

      data.forEach(item => {
        const li = document.createElement('li');
        li.setAttribute("data-name", item.name.toLowerCase());

        if (item.type === "dir") {
          li.innerHTML = "📁 <span class='folder'>" + item.name + "</span>";
          li.onclick = () => {
            li.innerHTML = "🔄 جاري التحميل...";
            loadFolder(path + "/" + item.name, li);
          };
        } else {
          const url = ghPagesBase + path + "/" + item.name;
          li.innerHTML = "📄 <a href='" + url + "' target='_blank' class='file'>" + item.name + "</a>";
        }
        ul.appendChild(li);
      });

      container.appendChild(ul);
    }

    function filterFiles() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const items = document.querySelectorAll("#fileList li");
      items.forEach(li => {
        li.style.display = li.getAttribute("data-name").includes(input) ? "" : "none";
      });
    }

    async function uploadFile() {
      const file = document.getElementById("uploadFile").files[0];
      const msg = document.getElementById("uploadMsg");

      if (!file || !isAdmin || !token) {
        msg.innerText = "❌ لا تملك صلاحية أو لم تختر ملفًا";
        return;
      }

      const reader = new FileReader();
      reader.onload = async function() {
        const base64File = reader.result.split(',')[1];
        const path = `${currentPath}/${file.name}`;

        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: "PUT",
          headers: {
            "Authorization": "token " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "رفع ملف من لوحة المستعرض",
            content: base64File,
            branch: branch
          })
        });

        if (res.ok) {
          msg.innerText = "✅ تم رفع الملف بنجاح!";
          loadFolder(currentPath);
        } else {
          const err = await res.json();
          msg.innerText = "❌ فشل في رفع الملف: " + (err.message || "خطأ غير معروف");
        }
      };
      reader.readAsDataURL(file);
    }

    loadFolder();
  </script>
</body>
</html>
