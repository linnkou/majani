<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم الأدمن</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
    
    body {
      font-family: 'Tajawal', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
    }
    
    .status-approved {
      color: #10b981;
      font-weight: bold;
    }
    
    .status-pending {
      color: #f59e0b;
      font-weight: bold;
    }
    
    .status-uploaded {
      color: #6366f1;
      font-weight: bold;
    }
    
    .upload-progress {
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-top: 4px;
    }
    
    .upload-progress-bar {
      height: 100%;
      background-color: #10b981;
      transition: width 0.3s ease;
    }
    
    .github-auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    
    .github-auth-content {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 500px;
      width: 100%;
    }
    
    /* عناصر UI إضافية */
    .btn-primary {
      background-color: #6366f1;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-primary:hover {
      background-color: #4f46e5;
    }
    
    .btn-primary:disabled {
      background-color: #c7d2fe;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #e5e7eb;
      color: #374151;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-secondary:hover {
      background-color: #d1d5db;
    }
    
    .btn-danger {
      background-color: #ef4444;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .btn-danger:hover {
      background-color: #dc2626;
    }
    
    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem;
      border-radius: 0.375rem;
      background-color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 40;
      transition: transform 0.3s, opacity 0.3s;
      transform: translateY(-1rem);
      opacity: 0;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification-success {
      border-right: 4px solid #10b981;
    }
    
    .notification-error {
      border-right: 4px solid #ef4444;
    }
    
    .notification-info {
      border-right: 4px solid #6366f1;
    }

    /* توضيح خطوات إنشاء توكن GitHub */
    .github-token-steps {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      font-size: 0.875rem;
    }
    
    .github-token-steps h4 {
      color: #4b5563;
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    
    .github-token-steps ol {
      color: #6b7280;
      margin-bottom: 0;
      padding-right: 1.5rem;
    }
    
    .github-token-steps li {
      margin-bottom: 0.25rem;
    }
    
    .github-token-steps code {
      background-color: #e5e7eb;
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.8125rem;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- رأس الصفحة -->
  <header class="bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 shadow-lg">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold flex items-center">
          <i class="fas fa-user-shield ml-2"></i>
          لوحة تحكم الأدمن
        </h1>
        <div class="space-x-2 space-x-reverse">
          <button onclick="goToSite()" class="btn-secondary">
            <i class="fas fa-home ml-1"></i>
            الموقع الرئيسي
          </button>
          <button onclick="logoutUser()" class="btn-danger">
            <i class="fas fa-sign-out-alt ml-1"></i>
            تسجيل الخروج
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- قائمة التنقل -->
  <nav class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-3">
      <div class="flex flex-wrap gap-2">
        <button onclick="showTab('users')" id="tab-btn-users" class="btn-primary">
          <i class="fas fa-users ml-1"></i>
          إدارة المستخدمين
        </button>
        <button onclick="showTab('browser-files')" id="tab-btn-browser-files" class="btn-secondary">
          <i class="fas fa-file-upload ml-1"></i>
          الملفات المرفوعة
        </button>
        <button onclick="showTab('settings')" id="tab-btn-settings" class="btn-secondary">
          <i class="fas fa-cog ml-1"></i>
          إعدادات GitHub
        </button>
      </div>
    </div>
  </nav>

  <!-- المحتوى الرئيسي -->
  <main class="container mx-auto px-4 py-8 flex-grow">
    <!-- قسم المستخدمين -->
    <div id="tab-users" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">
          <i class="fas fa-users ml-2 text-indigo-600"></i>
          قائمة المستخدمين
        </h2>
        <div class="relative">
          <input type="text" id="searchUsers" placeholder="البحث عن مستخدم..." 
                 class="border border-gray-300 rounded-lg px-3 py-2 pr-9 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم المستخدم</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">البريد الإلكتروني</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">كلمة المرور</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراء</th>
            </tr>
          </thead>
          <tbody id="userTable" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
    
    <!-- قسم الملفات المرفوعة -->
    <div id="tab-browser-files" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">
          <i class="fas fa-file-upload ml-2 text-indigo-600"></i>
          الملفات بانتظار الموافقة
        </h2>
        <div class="relative">
          <input type="text" id="searchFiles" placeholder="البحث في الملفات..." 
                 class="border border-gray-300 rounded-lg px-3 py-2 pr-9 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المسار</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم الملف</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">رفعه</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">التاريخ</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراء</th>
            </tr>
          </thead>
          <tbody id="browserFilesTable" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
    
    <!-- قسم إعدادات GitHub -->
    <div id="tab-settings" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
      <h2 class="text-xl font-bold text-gray-800 mb-6">
        <i class="fab fa-github ml-2 text-indigo-600"></i>
        إعدادات GitHub
      </h2>
      
      <div class="max-w-lg mx-auto">
        <div class="github-token-steps">
          <h4>كيفية إنشاء رمز وصول شخصي (Personal Access Token) على GitHub:</h4>
          <ol>
            <li>سجل دخولك إلى حسابك على GitHub</li>
            <li>اذهب إلى Settings > Developer settings > Personal access tokens > Tokens (classic)</li>
            <li>انقر على "Generate new token" ثم "Generate new token (classic)"</li>
            <li>أدخل وصفاً للرمز مثل "رمز لوحة تحكم الأدمن"</li>
            <li>حدد صلاحية الرمز (مثلاً 30 يوماً)</li>
            <li>حدد نطاقات الوصول التالية: <code>repo</code> (كامل صلاحيات المستودع)</li>
            <li>انقر على "Generate token" وانسخ الرمز المُنشأ (لن تستطيع رؤيته مرة أخرى)</li>
          </ol>
        </div>

        <div class="mb-4">
          <label for="githubToken" class="block text-sm font-medium text-gray-700 mb-1">رمز الوصول الشخصي (Personal Access Token)</label>
          <div class="mt-1 relative rounded-md shadow-sm">
            <input type="password" id="githubToken" 
                   class="block w-full pr-10 border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                   placeholder="أدخل رمز الوصول الخاص بك على GitHub">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
              <button id="toggleTokenVisibility" type="button" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>
          <p class="mt-1 text-sm text-gray-500">يستخدم هذا الرمز للوصول إلى مستودع GitHub الخاص بك لرفع الملفات المعتمدة تلقائيًا.</p>
        </div>
        
        <div class="mb-4">
          <label for="githubRepo" class="block text-sm font-medium text-gray-700 mb-1">المستودع (Repository)</label>
          <input type="text" id="githubRepo" value="linnkou/majani" 
                 class="block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                 placeholder="المستخدم/اسم-المستودع">
        </div>
        
        <div class="mb-4">
          <label for="githubBranch" class="block text-sm font-medium text-gray-700 mb-1">الفرع (Branch)</label>
          <input type="text" id="githubBranch" value="main" 
                 class="block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                 placeholder="اسم الفرع">
        </div>
        
        <div class="mb-4">
          <label for="githubPath" class="block text-sm font-medium text-gray-700 mb-1">المسار الأساسي في المستودع</label>
          <input type="text" id="githubPath" value="educationdzwordland" 
                 class="block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                 placeholder="المسار داخل المستودع">
        </div>
        
        <div class="mt-6 flex justify-end">
          <button onclick="testGitHubConnection()" class="btn-secondary ml-2">
            <i class="fas fa-vial ml-1"></i>
            اختبار الاتصال
          </button>
          <button onclick="saveGitHubSettings()" class="btn-primary">
            <i class="fas fa-save ml-1"></i>
            حفظ الإعدادات
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- نافذة منبثقة لمصادقة GitHub -->
  <div id="githubAuthModal" class="github-auth-modal hidden">
    <div class="github-auth-content">
      <h3 class="text-xl font-bold mb-4">تهيئة رفع الملفات إلى GitHub</h3>
      <p class="mb-4">يجب إعداد رمز الوصول الشخصي (Personal Access Token) لتتمكن من رفع الملفات إلى مستودع GitHub الخاص بك.</p>
      
      <div class="github-token-steps">
        <h4>كيفية إنشاء الرمز:</h4>
        <ol>
          <li>سجل دخولك إلى حسابك على GitHub</li>
          <li>اذهب إلى Settings > Developer settings > Personal access tokens > Tokens (classic)</li>
          <li>انقر على "Generate new token" ثم "Generate new token (classic)"</li>
          <li>حدد نطاق <code>repo</code> (كامل صلاحيات المستودع)</li>
          <li>انقر على "Generate token" وانسخ الرمز</li>
        </ol>
      </div>
      
      <div class="mb-4">
        <label for="authToken" class="block text-sm font-medium text-gray-700 mb-1">رمز الوصول</label>
        <input type="text" id="authToken" 
               class="block w-full border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
               placeholder="أدخل رمز الوصول الشخصي">
      </div>
      
      <div class="flex justify-end gap-2">
        <button onclick="closeGitHubAuthModal()" class="btn-secondary">إلغاء</button>
        <button onclick="saveAuthToken()" class="btn-primary">حفظ</button>
      </div>
    </div>
  </div>

  <!-- القسم السفلي -->
  <footer class="bg-gray-800 text-white py-4 text-center">
    <div class="container mx-auto">
      <p>© 2025 منصة التعليم الجزائري - جميع الحقوق محفوظة</p>
    </div>
  </footer>

  <script>
    // معلومات GitHub
    let githubSettings = {
      token: "",
      repo: "linnkou/majani",
      branch: "main",
      basePath: "educationdzwordland"
    };

    // دالة تسجيل الخروج
    function logoutUser() {
      localStorage.removeItem("currentUser");
      window.location.href = "login.html";
    }

    // دالة الانتقال إلى الموقع الرئيسي
    function goToSite() {
      window.location.href = "index.html";
    }

    // دالة عرض علامة التبويب المحددة
    function showTab(tab) {
      // إخفاء جميع علامات التبويب
      document.getElementById("tab-users").classList.add("hidden");
      document.getElementById("tab-browser-files").classList.add("hidden");
      document.getElementById("tab-settings").classList.add("hidden");
      
      // إعادة تعيين أزرار التبويب
      document.getElementById("tab-btn-users").classList.remove("btn-primary");
      document.getElementById("tab-btn-users").classList.add("btn-secondary");
      document.getElementById("tab-btn-browser-files").classList.remove("btn-primary");
      document.getElementById("tab-btn-browser-files").classList.add("btn-secondary");
      document.getElementById("tab-btn-settings").classList.remove("btn-primary");
      document.getElementById("tab-btn-settings").classList.add("btn-secondary");
      
      // عرض علامة التبويب المحددة
      document.getElementById(`tab-${tab}`).classList.remove("hidden");
      document.getElementById(`tab-btn-${tab}`).classList.remove("btn-secondary");
      document.getElementById(`tab-btn-${tab}`).classList.add("btn-primary");
    }

    // دالة تحميل بيانات المستخدمين
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const tbody = document.getElementById("userTable");
      tbody.innerHTML = "";

      users.forEach((user, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                <i class="fas fa-user text-indigo-600"></i>
              </div>
              <div class="mr-4">
                <div class="text-sm font-medium text-gray-900">${user.username}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${user.email || 'غير متوفر'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${user.password}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${user.approved ? 'مقبول' : 'بانتظار الموافقة'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-left space-x-2 space-x-reverse">
            ${user.approved ? '' : `
            <button onclick="approveUser(${index})" class="btn-primary text-xs">
              <i class="fas fa-check ml-1"></i>
              موافقة
            </button>`}
            <button onclick="deleteUser(${index})" class="btn-danger text-xs">
              <i class="fas fa-trash-alt ml-1"></i>
              حذف
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // دالة الموافقة على مستخدم
    function approveUser(index) {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      users[index].approved = true;
      localStorage.setItem("users", JSON.stringify(users));
      loadUsers();
      showNotification("تمت الموافقة على المستخدم بنجاح", "success");
    }

    // دالة حذف مستخدم
    function deleteUser(index) {
      if (confirm("هل أنت متأكد من رغبتك في حذف هذا المستخدم؟")) {
        const users = JSON.parse(localStorage.getItem("users") || "[]");
        users.splice(index, 1);
        localStorage.setItem("users", JSON.stringify(users));
        loadUsers();
        showNotification("تم حذف المستخدم بنجاح", "success");
      }
    }

    // تحميل الملفات المنتظرة الموافقة
    function loadBrowserFiles() {
      const files = JSON.parse(localStorage.getItem("browserFiles") || "[]");
      const pendingFiles = files.filter(file => !file.approved);
      const tbody = document.getElementById("browserFilesTable");
      tbody.innerHTML = "";

      if (pendingFiles.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-6 py-10 text-center text-gray-500">
              <i class="fas fa-check-circle text-2xl mb-2 text-green-500"></i>
              <p>لا توجد ملفات بانتظار الموافقة</p>
            </td>
          </tr>
        `;
        return;
      }

      pendingFiles.forEach((file, index) => {
        const fileIndex = files.findIndex(f => 
          f.name === file.name && 
          f.path === file.path && 
          f.timestamp === file.timestamp
        );
        
        // إنشاء معرف فريد للملف باستخدام مساره واسمه وتوقيته
        const fileId = `${file.path}-${file.name}-${file.timestamp}`.replace(/[^a-z0-9]/gi, '-');
        
        const row = document.createElement("tr");
        // إضافة سمة بيانات لتحديد الصف بشكل فريد
        row.setAttribute("data-file-id", fileId);
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${file.path || 'المجلد الرئيسي'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 flex items-center justify-center">
                <i class="fas ${getFileIcon(file.name)} text-lg ${getFileIconColor(file.name)}"></i>
              </div>
              <div class="mr-4">
                <div class="text-sm font-medium text-gray-900">${file.name}</div>
                <div class="text-xs text-gray-500">${formatFileSize(file.size || 0)}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${file.uploadedBy || 'مجهول'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${formatDate(new Date(file.timestamp))}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
              بانتظار الموافقة
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-left space-x-2 space-x-reverse">
            <button onclick="approveAndUploadFile(${fileIndex})" class="btn-primary text-xs">
              <i class="fas fa-check ml-1"></i>
              موافقة ورفع
            </button>
            <button onclick="deleteBrowserFile(${fileIndex})" class="btn-danger text-xs">
              <i class="fas fa-trash-alt ml-1"></i>
              حذف
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // دالة الحصول على أيقونة الملف المناسبة
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      
      if (['pdf'].includes(ext)) return 'fa-file-pdf';
      if (['doc', 'docx'].includes(ext)) return 'fa-file-word';
      if (['xls', 'xlsx'].includes(ext)) return 'fa-file-excel';
      if (['ppt', 'pptx'].includes(ext)) return 'fa-file-powerpoint';
      if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'fa-file-image';
      if (['zip', 'rar'].includes(ext)) return 'fa-file-archive';
      if (['txt'].includes(ext)) return 'fa-file-alt';
      
      return 'fa-file';
    }

    // دالة الحصول على لون أيقونة الملف
    function getFileIconColor(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      
      if (['pdf'].includes(ext)) return 'text-red-500';
      if (['doc', 'docx'].includes(ext)) return 'text-blue-500';
      if (['xls', 'xlsx'].includes(ext)) return 'text-green-500';
      if (['ppt', 'pptx'].includes(ext)) return 'text-orange-500';
      if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'text-purple-500';
      if (['zip', 'rar'].includes(ext)) return 'text-yellow-600';
      if (['txt'].includes(ext)) return 'text-gray-500';
      
      return 'text-gray-400';
    }

    // دالة تنسيق حجم الملف
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // دالة تنسيق التاريخ
    function formatDate(date) {
      return new Intl.DateTimeFormat('ar-SA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    }

    // دالة لتشفير النصوص بما فيها Unicode إلى Base64
    function utf8ToBase64(str) {
      try {
        return btoa(unescape(encodeURIComponent(str)));
      } catch (error) {
        console.error("خطأ في تشفير Base64:", error);
        return "";
      }
    }

    // دالة الموافقة ورفع الملف إلى GitHub
    async function approveAndUploadFile(index) {
      // التحقق من وجود الرمز
      if (!githubSettings.token) {
        showGitHubAuthModal();
        return;
      }
      
      const files = JSON.parse(localStorage.getItem("browserFiles") || "[]");
      const file = files[index];
      
      if (!file) {
        showNotification("لم يتم العثور على الملف المحدد", "error");
        return;
      }
      
      // العثور على الصف المناسب باستخدام سمات البيانات
      const fileId = `${file.path}-${file.name}-${file.timestamp}`.replace(/[^a-z0-9]/gi, '-');
      const row = document.querySelector(`#browserFilesTable tr[data-file-id="${fileId}"]`);
      
      if (!row) {
        console.error("لم يتم العثور على صف الملف في الجدول", fileId);
        showNotification("حدث خطأ أثناء تحديد الملف في الجدول", "error");
        return;
      }
      
      const statusCell = row.querySelector('td:nth-child(5)');
      const actionCell = row.querySelector('td:nth-child(6)');
      
      statusCell.innerHTML = `
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
          جاري الرفع...
        </span>
        <div class="upload-progress mt-1">
          <div class="upload-progress-bar" style="width: 10%"></div>
        </div>
      `;
      
      actionCell.innerHTML = `
        <button disabled class="btn-secondary text-xs opacity-50 cursor-not-allowed">
          <i class="fas fa-spinner fa-spin ml-1"></i>
          جاري الرفع
        </button>
      `;
      
      try {
        console.log("بدء عملية رفع الملف:", file.name);
        
        // تحديث شريط التقدم إلى 30%
        updateProgressBar(row, 30);
        
        // محاكاة تحميل ملف (في الحالة الحقيقية، سيكون هناك محتوى فعلي للملف)
        // هنا نستخدم محتوى نصي بسيط للتجربة
        const fileContent = `This is a sample file content for ${file.name}\nUploaded by ${file.uploadedBy || 'admin'}\nDate: ${new Date().toISOString()}`;
        console.log("تم تجهيز محتوى الملف");
        
        // تحديث شريط التقدم إلى 50%
        updateProgressBar(row, 50);
        
        // رفع الملف إلى GitHub
        console.log("جاري رفع الملف إلى GitHub:", file.path, file.name);
        const result = await uploadToGitHub(file.path, file.name, fileContent);
        console.log("تم الرفع بنجاح:", result);
        
        // تحديث شريط التقدم إلى 100%
        updateProgressBar(row, 100);
        
        // تحديث حالة الملف في التخزين المحلي
        files[index].approved = true;
        files[index].githubUploaded = true;
        files[index].githubSha = result.content?.sha || '';
        localStorage.setItem("browserFiles", JSON.stringify(files));
        console.log("تم تحديث حالة الملف في التخزين المحلي");
        
        // تحديث واجهة المستخدم بعد الانتهاء
        setTimeout(() => {
          statusCell.innerHTML = `
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
              تمت الموافقة والرفع
            </span>
          `;
          
          actionCell.innerHTML = `
            <button disabled class="btn-primary text-xs opacity-50 cursor-not-allowed">
              <i class="fas fa-check ml-1"></i>
              تم الرفع
            </button>
            <a href="${result.content?.html_url || '#'}" target="_blank" class="btn-secondary text-xs mr-1">
              <i class="fab fa-github ml-1"></i>
              عرض
            </a>
          `;
          
          showNotification(`تم رفع الملف ${file.name} بنجاح إلى GitHub`, "success");
          
          // إعادة تحميل الملفات بعد ثانيتين
          setTimeout(() => {
            loadBrowserFiles();
          }, 2000);
        }, 500);
      } catch (error) {
        console.error("خطأ في رفع الملف:", error);
        
        statusCell.innerHTML = `
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
            فشل الرفع
          </span>
        `;
        
        actionCell.innerHTML = `
          <button onclick="approveAndUploadFile(${index})" class="btn-primary text-xs">
            <i class="fas fa-redo ml-1"></i>
            إعادة المحاولة
          </button>
          <button onclick="deleteBrowserFile(${index})" class="btn-danger text-xs">
            <i class="fas fa-trash-alt ml-1"></i>
            حذف
          </button>
        `;
        
        showNotification(`فشل رفع الملف: ${error.message}`, "error");
      }
    }

    // تحديث شريط التقدم
    function updateProgressBar(row, percentage) {
      const progressBar = row.querySelector('.upload-progress-bar');
      if (progressBar) {
        progressBar.style.width = `${percentage}%`;
      }
    }

    // دالة رفع الملف إلى GitHub
    async function uploadToGitHub(path, filename, content) {
      // التحقق من وجود الرمز
      if (!githubSettings.token) {
        throw new Error("لم يتم تعيين رمز الوصول إلى GitHub");
      }
      
      if (!githubSettings.repo || !githubSettings.branch) {
        throw new Error("يرجى تعيين المستودع والفرع بشكل صحيح");
      }
      
      // تحضير المسار الكامل للملف
      const filePath = `${githubSettings.basePath}/${path ? path + '/' : ''}${filename}`;
      
      // تحضير بيانات الطلب
      const requestData = {
        message: `تم رفع ${filename} بواسطة لوحة التحكم`,
        content: utf8ToBase64(content),
        branch: githubSettings.branch
      };

      try {
        // إرسال الطلب إلى GitHub API
        const response = await fetch(
          `https://api.github.com/repos/${githubSettings.repo}/contents/${filePath}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${githubSettings.token}`,
              'Content-Type': 'application/json',
              'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(requestData)
          }
        );
        
        // التحقق من نجاح الطلب
        if (!response.ok) {
          const errorData = await response.json();
          const errorMessage = errorData.message || response.statusText;
          console.error("خطأ GitHub API:", errorData);
          
          // رسائل خطأ أكثر تفصيلاً
          if (response.status === 401) {
            throw new Error("رمز الوصول غير صالح أو منتهي الصلاحية. يرجى تحديث رمز الوصول الشخصي.");
          } else if (response.status === 404) {
            throw new Error("المستودع غير موجود أو ليس لديك صلاحية الوصول إليه. تحقق من اسم المستودع.");
          } else if (response.status === 422 && errorMessage.includes("sha")) {
            throw new Error("الملف موجود بالفعل في المستودع. يجب توفير SHA للتحديث.");
          } else {
            throw new Error(`فشل رفع الملف: ${errorMessage}`);
          }
        }
        
        // استرجاع البيانات
        const data = await response.json();
        
        // إضافة رابط لعرض الملف على GitHub
        data.content.html_url = `https://github.com/${githubSettings.repo}/blob/${githubSettings.branch}/${filePath}`;
        
        return data;
      } catch (error) {
        console.error("خطأ أثناء رفع الملف إلى GitHub:", error);
        throw error;
      }
    }

    // دالة اختبار الاتصال بـ GitHub
    async function testGitHubConnection() {
      const token = document.getElementById("githubToken").value.trim();
      const repo = document.getElementById("githubRepo").value.trim();
      
      if (!token) {
        showNotification("يرجى إدخال رمز الوصول الشخصي أولاً", "error");
        return;
      }
      
      if (!repo) {
        showNotification("يرجى إدخال اسم المستودع بتنسيق username/repository", "error");
        return;
      }
      
      try {
        showNotification("جاري اختبار الاتصال...", "info");
        
        const response = await fetch(
          `https://api.github.com/repos/${repo}`,
          {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          }
        );
        
        if (response.ok) {
          const repoData = await response.json();
          showNotification(`تم الاتصال بنجاح بمستودع ${repoData.name}`, "success");
        } else {
          const errorData = await response.json();
          if (response.status === 401) {
            showNotification("رمز الوصول غير صالح أو منتهي الصلاحية", "error");
          } else if (response.status === 404) {
            showNotification("المستودع غير موجود أو ليس لديك صلاحية الوصول إليه", "error");
          } else {
            showNotification(`خطأ: ${errorData.message}`, "error");
          }
        }
      } catch (error) {
        console.error("خطأ أثناء اختبار الاتصال:", error);
        showNotification(`خطأ في الاتصال: ${error.message}`, "error");
      }
    }

    // دالة حذف ملف من قائمة الملفات المرفوعة
    function deleteBrowserFile(index) {
      if (confirm("هل أنت متأكد من رغبتك في حذف هذا الملف؟")) {
        const files = JSON.parse(localStorage.getItem("browserFiles") || "[]");
        files.splice(index, 1);
        localStorage.setItem("browserFiles", JSON.stringify(files));
        loadBrowserFiles();
        showNotification("تم حذف الملف بنجاح", "success");
      }
    }

    // دالة عرض نافذة مصادقة GitHub
    function showGitHubAuthModal() {
      document.getElementById("githubAuthModal").classList.remove("hidden");
    }

    // دالة إغلاق نافذة مصادقة GitHub
    function closeGitHubAuthModal() {
      document.getElementById("githubAuthModal").classList.add("hidden");
    }

    // دالة حفظ رمز الوصول
    function saveAuthToken() {
      const token = document.getElementById("authToken").value.trim();
      
      if (!token) {
        showNotification("يرجى إدخال رمز وصول صحيح", "error");
        return;
      }
      
      githubSettings.token = token;
      document.getElementById("githubToken").value = token;
      closeGitHubAuthModal();
      showNotification("تم حفظ رمز الوصول بنجاح", "success");
    }

    // دالة حفظ إعدادات GitHub
    function saveGitHubSettings() {
      const token = document.getElementById("githubToken").value.trim();
      const repo = document.getElementById("githubRepo").value.trim();
      const branch = document.getElementById("githubBranch").value.trim();
      const basePath = document.getElementById("githubPath").value.trim();
      
      if (!repo || !branch) {
        showNotification("يرجى ملء جميع الحقول المطلوبة", "error");
        return;
      }
      
      githubSettings = {
        token: token,
        repo: repo,
        branch: branch,
        basePath: basePath
      };
      
      // حفظ الإعدادات في localStorage (باستثناء الرمز)
      localStorage.setItem("githubSettings", JSON.stringify({
        repo: repo,
        branch: branch,
        basePath: basePath
        // لا نحفظ الرمز لأسباب أمنية
      }));
      
      showNotification("تم حفظ الإعدادات بنجاح", "success");
    }

    // دالة عرض الإشعارات
    function showNotification(message, type = "info") {
      // إزالة الإشعارات السابقة
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => {
        notification.remove();
      });
      
      // إنشاء الإشعار الجديد
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      
      let icon;
      switch (type) {
        case 'success':
          icon = 'fa-check-circle text-green-500';
          break;
        case 'error':
          icon = 'fa-exclamation-circle text-red-500';
          break;
        default:
          icon = 'fa-info-circle text-indigo-500';
      }
      
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${icon} text-lg ml-2"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // عرض الإشعار بتأثير انزلاق
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);
      
      // إخفاء الإشعار بعد 3 ثوان
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }

    // تبديل رؤية رمز GitHub
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('toggleTokenVisibility');
      const tokenInput = document.getElementById('githubToken');
      
      toggleButton.addEventListener('click', function() {
        const type = tokenInput.getAttribute('type') === 'password' ? 'text' : 'password';
        tokenInput.setAttribute('type', type);
        toggleButton.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      });
    });

    // التحقق من وجود المستخدم المسجل
    document.addEventListener("DOMContentLoaded", () => {
      const currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");
      
      // تعليق هذا التحقق للتطوير والاختبار
      /* if (!(currentUser && currentUser.username === "latifking" && currentUser.password === "ding2010")) {
        window.location.href = "login.html";
      } */
      
      // تحميل إعدادات GitHub إذا كانت متوفرة
      const savedSettings = JSON.parse(localStorage.getItem("githubSettings") || "null");
      if (savedSettings) {
        githubSettings.repo = savedSettings.repo || githubSettings.repo;
        githubSettings.branch = savedSettings.branch || githubSettings.branch;
        githubSettings.basePath = savedSettings.basePath || githubSettings.basePath;
        
        // تحديث حقول النموذج
        document.getElementById("githubRepo").value = githubSettings.repo;
        document.getElementById("githubBranch").value = githubSettings.branch;
        document.getElementById("githubPath").value = githubSettings.basePath;
      }
      
      // تحميل البيانات
      loadUsers();
      loadBrowserFiles();
      
      // إضافة بيانات تجريبية إذا لم تكن موجودة
      if (!localStorage.getItem("browserFiles")) {
        // إنشاء بعض الملفات التجريبية للعرض
        const demoFiles = [
          {
            name: "presentation.pptx",
            path: "lessons/grade9",
            size: 2500000,
            uploadedBy: "teacher1",
            timestamp: Date.now() - 86400000, // يوم واحد مضى
            approved: false
          },
          {
            name: "worksheet.pdf",
            path: "exercises",
            size: 1200000,
            uploadedBy: "teacher2",
            timestamp: Date.now() - 43200000, // 12 ساعة مضت
            approved: false
          },
          {
            name: "example.txt",
            path: "documents",
            size: 5000,
            uploadedBy: "admin",
            timestamp: Date.now() - 3600000, // ساعة واحدة مضت
            approved: false
          }
        ];
        localStorage.setItem("browserFiles", JSON.stringify(demoFiles));
        loadBrowserFiles();
      }
      
      // إضافة بيانات مستخدمين تجريبية إذا لم تكن موجودة
      if (!localStorage.getItem("users")) {
        const demoUsers = [
          {
            username: "latifking",
            email: "admin@example.com",
            password: "ding2010",
            approved: true,
            isAdmin: true
          },
          {
            username: "teacher1",
            email: "teacher1@example.com",
            password: "password123",
            approved: true,
            isAdmin: false
          },
          {
            username: "newuser",
            email: "newuser@example.com",
            password: "newuser123",
            approved: false,
            isAdmin: false
          }
        ];
        localStorage.setItem("users", JSON.stringify(demoUsers));
        loadUsers();
      }
    });
  </script>
</body>
</html>